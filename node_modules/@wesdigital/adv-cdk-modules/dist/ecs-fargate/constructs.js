"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommonServiceDef = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const wesdigital_1 = require("../wesdigital");
const aws_ecs_1 = require("aws-cdk-lib/aws-ecs");
const kms_1 = require("../kms");
const aws_logs_1 = require("aws-cdk-lib/aws-logs");
const lambda_1 = require("../lambda");
const aws_logs_destinations_1 = require("aws-cdk-lib/aws-logs-destinations");
const aws_secretsmanager_1 = require("aws-cdk-lib/aws-secretsmanager");
const aws_ecr_1 = require("aws-cdk-lib/aws-ecr");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_ssm_1 = require("aws-cdk-lib/aws-ssm");
const aws_ecs_patterns_1 = require("aws-cdk-lib/aws-ecs-patterns");
class CommonServiceDef extends constructs_1.Construct {
    constructor(scope, id, taskDefProps) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q;
        super(scope, id);
        const props = taskDefProps.fargate;
        const accountNumber = aws_cdk_lib_1.Stack.of(this).account;
        const envProps = {
            account: accountNumber,
            env: props.deploymentEnv
        };
        const env = (0, wesdigital_1.wesDigitalEnv)(envProps);
        const namePrefix = `${props.identifier}${props.deploymentEnv}-${props.imageName}`;
        const clusterName = props.clusterName;
        const taskDef = new aws_ecs_1.FargateTaskDefinition(this, 'TaskDef', {
            cpu: props.taskDefinitionCpu,
            memoryLimitMiB: props.taskDefinitionMemory,
            volumes: props.volumes
        });
        const serviceKmsKey = new kms_1.StandardKMSKey(this, 'MainLogGroupKey', {
            keyName: `${props.identifier}-${props.imageName}-logs_key`,
            deploymentEnv: props.deploymentEnv
        });
        const logGroupName = `/ecs/${namePrefix}`;
        serviceKmsKey.addCloudwatchLogs([logGroupName]);
        this._kmsKey = serviceKmsKey.key;
        const mainLogGroup = new aws_logs_1.LogGroup(this, 'MainLogGroup', {
            logGroupName,
            retention: props.logRetentionInDays,
            encryptionKey: serviceKmsKey.key
        });
        const logLambda = (0, lambda_1.createLogLambda)(this, 'DatadogLambda');
        mainLogGroup.addSubscriptionFilter('DataDogSubscription', {
            destination: new aws_logs_destinations_1.LambdaDestination(logLambda),
            filterPattern: aws_logs_1.FilterPattern.allEvents()
        });
        const mainContainerName = props.containerName;
        const mainContainerSecrets = (_a = props.taskSecrets) === null || _a === void 0 ? void 0 : _a.externalSecretConfig.reduce((obj, secret) => {
            return {
                ...obj,
                [secret.envVar]: aws_ecs_1.Secret.fromSecretsManager(aws_secretsmanager_1.Secret.fromSecretNameV2(this, `SecretsManager${secret.lastPartOfSecretName}`, `/${props.identifier}${props.deploymentEnv}/${props.imageName}/${secret.lastPartOfSecretName}`))
            };
        }, (_b = props.taskSecrets) === null || _b === void 0 ? void 0 : _b.localSecrets);
        const mainContainerDef = taskDef.addContainer('MainContainer', {
            containerName: mainContainerName,
            image: aws_ecs_1.ContainerImage.fromEcrRepository(aws_ecr_1.Repository.fromRepositoryAttributes(this, 'MainRepository', {
                repositoryArn: aws_ecr_1.Repository.arnForLocalRepository(props.imageName, this, env.ecrAccount),
                repositoryName: props.imageName
            }), props.imageTag),
            portMappings: [{
                    containerPort: props.containerPort
                }],
            logging: aws_ecs_1.LogDriver.awsLogs({
                logGroup: mainLogGroup,
                streamPrefix: 'container'
            }),
            linuxParameters: new aws_ecs_1.LinuxParameters(this, 'MainContainerLinuxParameters', {
                initProcessEnabled: true
            }),
            secrets: mainContainerSecrets,
            environment: (_c = props.envVars) === null || _c === void 0 ? void 0 : _c.task,
            healthCheck: props.taskHealthCheck
        });
        if (props.taskMountPoints) {
            mainContainerDef.addMountPoints(...props.taskMountPoints);
        }
        const reverseDomainName = (domainName) => domainName.split('.').reverse().join('.');
        const datadogSecret = aws_secretsmanager_1.Secret.fromSecretNameV2(this, 'DatadogSecret', `/${props.deploymentEnv}/platform/datadog_ecs`);
        const datadogContainerDef = taskDef.addContainer('DatadogContainer', {
            containerName: `datadog-agent-${mainContainerName}`,
            image: aws_ecs_1.ContainerImage.fromEcrRepository(aws_ecr_1.Repository.fromRepositoryAttributes(this, 'DatadogRepository', {
                repositoryArn: aws_ecr_1.Repository.arnForLocalRepository(wesdigital_1.DatadogImage, this, env.ecrAccount),
                repositoryName: wesdigital_1.DatadogImage
            }), wesdigital_1.DatadogImageTag),
            logging: aws_ecs_1.LogDriver.awsLogs({
                logGroup: mainLogGroup,
                streamPrefix: 'datadog'
            }),
            portMappings: [
                {
                    containerPort: 8125,
                    hostPort: 8125,
                    protocol: aws_ecs_1.Protocol.UDP
                },
                {
                    hostPort: 8126,
                    containerPort: 8126,
                    protocol: aws_ecs_1.Protocol.TCP
                }
            ],
            secrets: {
                DD_API_KEY: aws_ecs_1.Secret.fromSecretsManager(datadogSecret)
            },
            environment: {
                ...(_d = props.envVars) === null || _d === void 0 ? void 0 : _d.dataDog,
                DD_APM_ENABLED: 'true',
                DD_APM_NON_LOCAL_TRAFFIC: 'true',
                DD_APM_RECEIVER_PORT: '8126',
                DD_DOCKER_LABELS_AS_TAGS: `{"${reverseDomainName(env.internalLb)}.alb.${props.imageName}.service_name":"service_name","${reverseDomainName(env.internalLb)}.alb.${props.imageName}.github_tag":"github_tag"}`,
                DD_DOGSTATSD_NON_LOCAL_TRAFFIC: 'true',
                DD_DOGSTATSD_PORT: '8125',
                DD_LOGS_ENABLED: 'true',
                DD_SITE: 'datadoghq.com',
                DD_TAGS: (0, wesdigital_1.getDataDogTags)({ ...props.ddTagsConfig, env: props.deploymentEnv }, { cluster: clusterName }),
                ECS_FARGATE: 'true'
            },
            healthCheck: {
                command: ['CMD-SHELL', 'agent health || exit 1']
            }
        });
        mainContainerDef.addContainerDependencies({
            container: datadogContainerDef,
            condition: aws_ecs_1.ContainerDependencyCondition.HEALTHY
        });
        const baseServiceCreationProps = {
            assignPublicIp: false,
            taskDefinition: taskDef,
            cluster: aws_ecs_1.Cluster.fromClusterAttributes(this, 'Cluster', {
                clusterName: props.clusterName,
                vpc: (0, wesdigital_1.wesDigitalVpc)(this, 'vpc', envProps),
                securityGroups: []
            }),
            serviceName: `${props.identifier}${props.deploymentEnv}-${props.imageName}`
        };
        const ServiceClass = taskDefProps.serviceType;
        const serviceCreationProps = ServiceClass === aws_ecs_patterns_1.ApplicationLoadBalancedFargateService
            ? { ...baseServiceCreationProps, publicLoadBalancer: false }
            : { ...baseServiceCreationProps };
        const fargateService = new ServiceClass(this, 'Service', serviceCreationProps);
        const scaleProps = {
            maxCapacity: (_f = (_e = props.autoscaling) === null || _e === void 0 ? void 0 : _e.max) !== null && _f !== void 0 ? _f : 3,
            minCapacity: (_h = (_g = props.autoscaling) === null || _g === void 0 ? void 0 : _g.min) !== null && _h !== void 0 ? _h : 1
        };
        const scaling = fargateService instanceof aws_ecs_1.FargateService ? fargateService.autoScaleTaskCount(scaleProps) : fargateService.service.autoScaleTaskCount(scaleProps);
        switch ((_j = props.autoscaling) === null || _j === void 0 ? void 0 : _j.metric) {
            case 'CPU':
                scaling.scaleOnCpuUtilization('CPUScaling', {
                    scaleInCooldown: props.autoscaling.scaleInCooldown,
                    scaleOutCooldown: props.autoscaling.scaleOutCooldown,
                    targetUtilizationPercent: props.autoscaling.targetValue
                });
                break;
            case 'Memory':
                scaling.scaleOnMemoryUtilization('MemoryScaling', {
                    scaleInCooldown: props.autoscaling.scaleInCooldown,
                    scaleOutCooldown: props.autoscaling.scaleOutCooldown,
                    targetUtilizationPercent: props.autoscaling.targetValue
                });
                break;
            default:
                scaling.scaleOnCpuUtilization('CPUScaling', {
                    scaleInCooldown: aws_cdk_lib_1.Duration.minutes(5),
                    scaleOutCooldown: aws_cdk_lib_1.Duration.minutes(1),
                    targetUtilizationPercent: 80
                });
                break;
        }
        const ddSecretPolicy = new aws_iam_1.PolicyStatement({
            actions: ['secretsmanager:GetSecretValue'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [datadogSecret.secretArn],
            sid: 'datadogsecret'
        });
        fargateService.taskDefinition.addToTaskRolePolicy(ddSecretPolicy);
        const ddKmsPolicy = new aws_iam_1.PolicyStatement({
            actions: [
                'kms:Decrypt',
                'kms:DescribeKey',
                'kms:GenerateDataKey'
            ],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [aws_ssm_1.StringParameter.valueForStringParameter(this, `/${props.deploymentEnv}/${props.clusterName}/ECS/${props.clusterName}`)],
            sid: 'clusterkmskey'
        });
        fargateService.taskDefinition.addToExecutionRolePolicy(ddKmsPolicy);
        fargateService.taskDefinition.addToTaskRolePolicy(ddKmsPolicy);
        if (props.msk) {
            const mskClusterPolicy = new aws_iam_1.PolicyStatement({
                actions: ['kafka-cluster:Connect'],
                effect: aws_iam_1.Effect.ALLOW,
                resources: [env.mskClusterArn],
                sid: 'klusterconnect'
            });
            fargateService.taskDefinition.addToTaskRolePolicy(mskClusterPolicy);
            if (props.msk.consumerTopics.length > 0) {
                const mskConsumerTopicPolicy = new aws_iam_1.PolicyStatement({
                    actions: [
                        'kafka-cluster:DescribeTopic',
                        'kafka-cluster:ReadData'
                    ],
                    effect: aws_iam_1.Effect.ALLOW,
                    resources: props.msk.consumerTopics.map(topic => `${env.mskClusterArn.replace('cluster', 'topic')}/${topic}`),
                    sid: 'mskconsumertopics'
                });
                fargateService.taskDefinition.addToTaskRolePolicy(mskConsumerTopicPolicy);
            }
            if (props.msk.consumerGroups.length > 0) {
                const mskConsumerGroupPolicy = new aws_iam_1.PolicyStatement({
                    actions: [
                        'kafka-cluster:AlterGroup',
                        'kafka-cluster:DescribeGroup'
                    ],
                    effect: aws_iam_1.Effect.ALLOW,
                    resources: props.msk.consumerGroups.map(group => `${env.mskClusterArn.replace('cluster', 'group')}/${group}`),
                    sid: 'mskconsumergroups'
                });
                fargateService.taskDefinition.addToTaskRolePolicy(mskConsumerGroupPolicy);
            }
            if (props.msk.producerTopics.length > 0) {
                const mskProducerPolicy = new aws_iam_1.PolicyStatement({
                    actions: [
                        'kafka-cluster:DescribeTopic',
                        'kafka-cluster:WriteData',
                        'kafka-cluster:WriteDataIdempotently'
                    ],
                    effect: aws_iam_1.Effect.ALLOW,
                    resources: props.msk.producerTopics.map(topic => `${env.mskClusterArn.replace('cluster', 'topic')}/${topic}`),
                    sid: 'mskproducer'
                });
                fargateService.taskDefinition.addToTaskRolePolicy(mskProducerPolicy);
            }
        }
        const tables = (_l = (_k = props.dynamo) === null || _k === void 0 ? void 0 : _k.tableNames) !== null && _l !== void 0 ? _l : [];
        if (tables.length > 0) {
            const dynamoResources = [
                ...tables.map(table => aws_cdk_lib_1.Stack.of(this).formatArn({
                    service: 'dynamodb',
                    resource: 'table',
                    resourceName: table
                })),
                ...tables.map(table => aws_cdk_lib_1.Stack.of(this).formatArn({
                    service: 'dynamodb',
                    resource: 'table',
                    resourceName: `${table}/index/*`
                }))
            ];
            const dynamoPolicy = new aws_iam_1.PolicyStatement({
                actions: [
                    'dynamodb:BatchGetItem',
                    'dynamodb:BatchWriteItem',
                    'dynamodb:ConditionCheckItem',
                    'dynamodb:DeleteItem',
                    'dynamodb:DescribeTable',
                    'dynamodb:GetItem',
                    'dynamodb:PutItem',
                    'dynamodb:Query',
                    'dynamodb:Scan',
                    'dynamodb:UpdateItem'
                ],
                effect: aws_iam_1.Effect.ALLOW,
                resources: dynamoResources,
                sid: 'dynamo'
            });
            fargateService.taskDefinition.addToTaskRolePolicy(dynamoPolicy);
            if ((_m = props.dynamo) === null || _m === void 0 ? void 0 : _m.addKeysToTaskRole) {
                const dynamoKmsPolicy = new aws_iam_1.PolicyStatement({
                    actions: [
                        'kms:CreateGrant',
                        'kms:Decrypt',
                        'kms:DescribeKey',
                        'kms:Encrypt',
                        'kms:GenerateDataKey*',
                        'kms:ReEncrypt*'
                    ],
                    effect: aws_iam_1.Effect.ALLOW,
                    resources: tables.map(table => aws_ssm_1.StringParameter.valueForStringParameter(this, `/${props.identifier}${props.deploymentEnv}/${props.imageName}/DYNAMODB/${table}`)),
                    sid: 'dynamokms'
                });
                fargateService.taskDefinition.addToTaskRolePolicy(dynamoKmsPolicy);
            }
        }
        const secretPolicy = new aws_iam_1.PolicyStatement({
            actions: ['secretsmanager:GetSecretValue'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [aws_cdk_lib_1.Stack.of(this).formatArn({
                    service: 'secretsmanager',
                    resource: 'secret:',
                    resourceName: `${props.identifier}${props.deploymentEnv}/${props.imageName}/*`
                })],
            sid: 'secrets'
        });
        fargateService.taskDefinition.addToExecutionRolePolicy(secretPolicy);
        fargateService.taskDefinition.addToTaskRolePolicy(secretPolicy);
        const secrets = (_p = (_o = props.taskSecrets) === null || _o === void 0 ? void 0 : _o.externalSecretConfig) !== null && _p !== void 0 ? _p : [];
        if (secrets.length > 0 && ((_q = props.taskSecrets) === null || _q === void 0 ? void 0 : _q.addKeysToTaskRole)) {
            const secretsKmsPolicy = new aws_iam_1.PolicyStatement({
                actions: [
                    'kms:CreateGrant',
                    'kms:Decrypt',
                    'kms:DescribeKey',
                    'kms:Encrypt',
                    'kms:GenerateDataKey*',
                    'kms:ReEncrypt*'
                ],
                effect: aws_iam_1.Effect.ALLOW,
                resources: secrets.map(secret => aws_ssm_1.StringParameter.valueForStringParameter(this, `/${props.identifier}${props.deploymentEnv}/${props.imageName}/EXTERNAL/${secret.lastPartOfSecretName}`)),
                sid: 'externalsecretskms'
            });
            fargateService.taskDefinition.addToExecutionRolePolicy(secretsKmsPolicy);
            fargateService.taskDefinition.addToTaskRolePolicy(secretsKmsPolicy);
        }
        const ssmParamPolicy = new aws_iam_1.PolicyStatement({
            actions: ['ssm:GetParameter', 'ssm:GetParameters'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [aws_cdk_lib_1.Stack.of(this).formatArn({
                    service: 'ssm',
                    resource: 'parameter',
                    resourceName: `${props.identifier}${props.deploymentEnv}/${props.imageName}/*`
                })],
            sid: 'ssmparams'
        });
        fargateService.taskDefinition.addToExecutionRolePolicy(ssmParamPolicy);
        fargateService.taskDefinition.addToTaskRolePolicy(ssmParamPolicy);
        const keyPolicy = new aws_iam_1.PolicyStatement({
            actions: ['kms:Decrypt'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [serviceKmsKey.key.keyArn],
            sid: 'fargatekey'
        });
        fargateService.taskDefinition.addToExecutionRolePolicy(keyPolicy);
        fargateService.taskDefinition.addToTaskRolePolicy(keyPolicy);
        this._service = fargateService;
    }
    get service() {
        return this._service;
    }
    get kmsKey() {
        return this._kmsKey;
    }
}
exports.CommonServiceDef = CommonServiceDef;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9lY3MtZmFyZ2F0ZS9jb25zdHJ1Y3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUFzQztBQUV0Qyw2Q0FBNkM7QUFDN0MsOENBS3NCO0FBQ3RCLGlEQVM0QjtBQUM1QixnQ0FBdUM7QUFDdkMsbURBQThEO0FBQzlELHNDQUEyQztBQUMzQyw2RUFBcUU7QUFDckUsdUVBQW1FO0FBQ25FLGlEQUFnRDtBQUVoRCxpREFBNkQ7QUFDN0QsaURBQXFEO0FBQ3JELG1FQUFvRjtBQU9wRixNQUFhLGdCQUFpQixTQUFRLHNCQUFTO0lBWTNDLFlBQWEsS0FBZ0IsRUFBRSxFQUFVLEVBQUUsWUFBZ0M7O1FBQ3ZFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFFaEIsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQTtRQUNsQyxNQUFNLGFBQWEsR0FBRyxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFrQyxDQUFBO1FBQ3ZFLE1BQU0sUUFBUSxHQUFhO1lBQ3ZCLE9BQU8sRUFBRSxhQUFhO1lBQ3RCLEdBQUcsRUFBRSxLQUFLLENBQUMsYUFBYTtTQUMzQixDQUFBO1FBQ0QsTUFBTSxHQUFHLEdBQUcsSUFBQSwwQkFBYSxFQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ25DLE1BQU0sVUFBVSxHQUFHLEdBQUcsS0FBSyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUNqRixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFBO1FBRXJDLE1BQU0sT0FBTyxHQUFHLElBQUksK0JBQXFCLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtZQUN2RCxHQUFHLEVBQUUsS0FBSyxDQUFDLGlCQUFpQjtZQUM1QixjQUFjLEVBQUUsS0FBSyxDQUFDLG9C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dHMnXG5pbXBvcnQgeyBGYXJnYXRlTW9kdWxlUHJvcHMgfSBmcm9tICcuL3Byb3BzJ1xuaW1wb3J0IHsgRHVyYXRpb24sIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInXG5pbXBvcnQge1xuICAgIERhdGFkb2dJbWFnZSxcbiAgICBEYXRhZG9nSW1hZ2VUYWcsIEVudlByb3BzLCBnZXREYXRhRG9nVGFncyxcbiAgICBXZXNkaWdpdGFsQWNjb3VudE51bWJlcixcbiAgICB3ZXNEaWdpdGFsRW52LCB3ZXNEaWdpdGFsVnBjXG59IGZyb20gJy4uL3dlc2RpZ2l0YWwnXG5pbXBvcnQge1xuICAgIENsdXN0ZXIsXG4gICAgQ29udGFpbmVyRGVwZW5kZW5jeUNvbmRpdGlvbixcbiAgICBDb250YWluZXJJbWFnZSwgRmFyZ2F0ZVNlcnZpY2UsXG4gICAgRmFyZ2F0ZVRhc2tEZWZpbml0aW9uLFxuICAgIExpbnV4UGFyYW1ldGVycyxcbiAgICBMb2dEcml2ZXIsXG4gICAgUHJvdG9jb2wsXG4gICAgU2VjcmV0XG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lY3MnXG5pbXBvcnQgeyBTdGFuZGFyZEtNU0tleSB9IGZyb20gJy4uL2ttcydcbmltcG9ydCB7IEZpbHRlclBhdHRlcm4sIExvZ0dyb3VwIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxvZ3MnXG5pbXBvcnQgeyBjcmVhdGVMb2dMYW1iZGEgfSBmcm9tICcuLi9sYW1iZGEnXG5pbXBvcnQgeyBMYW1iZGFEZXN0aW5hdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sb2dzLWRlc3RpbmF0aW9ucydcbmltcG9ydCB7IFNlY3JldCBhcyBTTVNlY3JldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlcidcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWNyJ1xuaW1wb3J0IHsgS2V5IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWttcydcbmltcG9ydCB7IEVmZmVjdCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSdcbmltcG9ydCB7IFN0cmluZ1BhcmFtZXRlciB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zc20nXG5pbXBvcnQgeyBBcHBsaWNhdGlvbkxvYWRCYWxhbmNlZEZhcmdhdGVTZXJ2aWNlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjcy1wYXR0ZXJucydcblxuZXhwb3J0IGludGVyZmFjZSBDb21tb25UYXNrRGVmUHJvcHMge1xuICAgIGZhcmdhdGU6IEZhcmdhdGVNb2R1bGVQcm9wc1xuICAgIHNlcnZpY2VUeXBlOiB0eXBlb2YgRmFyZ2F0ZVNlcnZpY2UgfCB0eXBlb2YgQXBwbGljYXRpb25Mb2FkQmFsYW5jZWRGYXJnYXRlU2VydmljZVxufVxuXG5leHBvcnQgY2xhc3MgQ29tbW9uU2VydmljZURlZiBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgZ2V0IHNlcnZpY2UgKCk6IEZhcmdhdGVTZXJ2aWNlIHwgQXBwbGljYXRpb25Mb2FkQmFsYW5jZWRGYXJnYXRlU2VydmljZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zZXJ2aWNlXG4gICAgfVxuXG4gICAgZ2V0IGttc0tleSAoKTogS2V5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ttc0tleVxuICAgIH1cblxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3NlcnZpY2U6IEZhcmdhdGVTZXJ2aWNlIHwgQXBwbGljYXRpb25Mb2FkQmFsYW5jZWRGYXJnYXRlU2VydmljZVxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2ttc0tleTogS2V5XG5cbiAgICBjb25zdHJ1Y3RvciAoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgdGFza0RlZlByb3BzOiBDb21tb25UYXNrRGVmUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkKVxuXG4gICAgICAgIGNvbnN0IHByb3BzID0gdGFza0RlZlByb3BzLmZhcmdhdGVcbiAgICAgICAgY29uc3QgYWNjb3VudE51bWJlciA9IFN0YWNrLm9mKHRoaXMpLmFjY291bnQgYXMgV2VzZGlnaXRhbEFjY291bnROdW1iZXJcbiAgICAgICAgY29uc3QgZW52UHJvcHM6IEVudlByb3BzID0ge1xuICAgICAgICAgICAgYWNjb3VudDogYWNjb3VudE51bWJlcixcbiAgICAgICAgICAgIGVudjogcHJvcHMuZGVwbG95bWVudEVudlxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGVudiA9IHdlc0RpZ2l0YWxFbnYoZW52UHJvcHMpXG4gICAgICAgIGNvbnN0IG5hbWVQcmVmaXggPSBgJHtwcm9wcy5pZGVudGlmaWVyfSR7cHJvcHMuZGVwbG95bWVudEVudn0tJHtwcm9wcy5pbWFnZU5hbWV9YFxuICAgICAgICBjb25zdCBjbHVzdGVyTmFtZSA9IHByb3BzLmNsdXN0ZXJOYW1lXG5cbiAgICAgICAgY29uc3QgdGFza0RlZiA9IG5ldyBGYXJnYXRlVGFza0RlZmluaXRpb24odGhpcywgJ1Rhc2tEZWYnLCB7XG4gICAgICAgICAgICBjcHU6IHByb3BzLnRhc2tEZWZpbml0aW9uQ3B1LFxuICAgICAgICAgICAgbWVtb3J5TGltaXRNaUI6IHByb3BzLnRhc2tEZWZpbml0aW9uTWVtb3J5LFxuICAgICAgICAgICAgdm9sdW1lczogcHJvcHMudm9sdW1lc1xuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IHNlcnZpY2VLbXNLZXkgPSBuZXcgU3RhbmRhcmRLTVNLZXkodGhpcywgJ01haW5Mb2dHcm91cEtleScsIHtcbiAgICAgICAgICAgIGtleU5hbWU6IGAke3Byb3BzLmlkZW50aWZpZXJ9LSR7cHJvcHMuaW1hZ2VOYW1lfS1sb2dzX2tleWAsXG4gICAgICAgICAgICBkZXBsb3ltZW50RW52OiBwcm9wcy5kZXBsb3ltZW50RW52XG4gICAgICAgIH0pXG4gICAgICAgIGNvbnN0IGxvZ0dyb3VwTmFtZSA9IGAvZWNzLyR7bmFtZVByZWZpeH1gXG4gICAgICAgIHNlcnZpY2VLbXNLZXkuYWRkQ2xvdWR3YXRjaExvZ3MoW2xvZ0dyb3VwTmFtZV0pXG4gICAgICAgIHRoaXMuX2ttc0tleSA9IHNlcnZpY2VLbXNLZXkua2V5XG5cbiAgICAgICAgY29uc3QgbWFpbkxvZ0dyb3VwID0gbmV3IExvZ0dyb3VwKHRoaXMsICdNYWluTG9nR3JvdXAnLCB7XG4gICAgICAgICAgICBsb2dHcm91cE5hbWUsXG4gICAgICAgICAgICByZXRlbnRpb246IHByb3BzLmxvZ1JldGVudGlvbkluRGF5cyxcbiAgICAgICAgICAgIGVuY3J5cHRpb25LZXk6IHNlcnZpY2VLbXNLZXkua2V5XG4gICAgICAgIH0pXG4gICAgICAgIGNvbnN0IGxvZ0xhbWJkYSA9IGNyZWF0ZUxvZ0xhbWJkYSh0aGlzLCAnRGF0YWRvZ0xhbWJkYScpXG4gICAgICAgIG1haW5Mb2dHcm91cC5hZGRTdWJzY3JpcHRpb25GaWx0ZXIoJ0RhdGFEb2dTdWJzY3JpcHRpb24nLCB7XG4gICAgICAgICAgICBkZXN0aW5hdGlvbjogbmV3IExhbWJkYURlc3RpbmF0aW9uKGxvZ0xhbWJkYSksXG4gICAgICAgICAgICBmaWx0ZXJQYXR0ZXJuOiBGaWx0ZXJQYXR0ZXJuLmFsbEV2ZW50cygpXG4gICAgICAgIH0pXG5cbiAgICAgICAgY29uc3QgbWFpbkNvbnRhaW5lck5hbWUgPSBwcm9wcy5jb250YWluZXJOYW1lXG4gICAgICAgIGNvbnN0IG1haW5Db250YWluZXJTZWNyZXRzID0gcHJvcHMudGFza1NlY3JldHM/LmV4dGVybmFsU2VjcmV0Q29uZmlnLnJlZHVjZSgob2JqLCBzZWNyZXQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4ub2JqLFxuICAgICAgICAgICAgICAgIFtzZWNyZXQuZW52VmFyXTogU2VjcmV0LmZyb21TZWNyZXRzTWFuYWdlcihcbiAgICAgICAgICAgICAgICAgICAgU01TZWNyZXQuZnJvbVNlY3JldE5hbWVWMihcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBgU2VjcmV0c01hbmFnZXIke3NlY3JldC5sYXN0UGFydE9mU2VjcmV0TmFtZX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgYC8ke3Byb3BzLmlkZW50aWZpZXJ9JHtwcm9wcy5kZXBsb3ltZW50RW52fS8ke3Byb3BzLmltYWdlTmFtZX0vJHtzZWNyZXQubGFzdFBhcnRPZlNlY3JldE5hbWV9YFxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCBwcm9wcy50YXNrU2VjcmV0cz8ubG9jYWxTZWNyZXRzKVxuICAgICAgICBjb25zdCBtYWluQ29udGFpbmVyRGVmID0gdGFza0RlZi5hZGRDb250YWluZXIoJ01haW5Db250YWluZXInLCB7XG4gICAgICAgICAgICBjb250YWluZXJOYW1lOiBtYWluQ29udGFpbmVyTmFtZSxcbiAgICAgICAgICAgIGltYWdlOiBDb250YWluZXJJbWFnZS5mcm9tRWNyUmVwb3NpdG9yeShcbiAgICAgICAgICAgICAgICBSZXBvc2l0b3J5LmZyb21SZXBvc2l0b3J5QXR0cmlidXRlcyh0aGlzLCAnTWFpblJlcG9zaXRvcnknLCB7XG4gICAgICAgICAgICAgICAgICAgIHJlcG9zaXRvcnlBcm46IFJlcG9zaXRvcnkuYXJuRm9yTG9jYWxSZXBvc2l0b3J5KFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuaW1hZ2VOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudi5lY3JBY2NvdW50XG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIHJlcG9zaXRvcnlOYW1lOiBwcm9wcy5pbWFnZU5hbWVcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBwcm9wcy5pbWFnZVRhZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHBvcnRNYXBwaW5nczogW3tcbiAgICAgICAgICAgICAgICBjb250YWluZXJQb3J0OiBwcm9wcy5jb250YWluZXJQb3J0XG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICAgIGxvZ2dpbmc6IExvZ0RyaXZlci5hd3NMb2dzKHtcbiAgICAgICAgICAgICAgICBsb2dHcm91cDogbWFpbkxvZ0dyb3VwLFxuICAgICAgICAgICAgICAgIHN0cmVhbVByZWZpeDogJ2NvbnRhaW5lcidcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbGludXhQYXJhbWV0ZXJzOiBuZXcgTGludXhQYXJhbWV0ZXJzKHRoaXMsICdNYWluQ29udGFpbmVyTGludXhQYXJhbWV0ZXJzJywge1xuICAgICAgICAgICAgICAgIGluaXRQcm9jZXNzRW5hYmxlZDogdHJ1ZVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzZWNyZXRzOiBtYWluQ29udGFpbmVyU2VjcmV0cyxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiBwcm9wcy5lbnZWYXJzPy50YXNrLFxuICAgICAgICAgICAgaGVhbHRoQ2hlY2s6IHByb3BzLnRhc2tIZWFsdGhDaGVja1xuICAgICAgICB9KVxuICAgICAgICBpZiAocHJvcHMudGFza01vdW50UG9pbnRzKSB7XG4gICAgICAgICAgICBtYWluQ29udGFpbmVyRGVmLmFkZE1vdW50UG9pbnRzKC4uLnByb3BzLnRhc2tNb3VudFBvaW50cylcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJldmVyc2VEb21haW5OYW1lID0gKGRvbWFpbk5hbWU6IHN0cmluZykgPT4gZG9tYWluTmFtZS5zcGxpdCgnLicpLnJldmVyc2UoKS5qb2luKCcuJylcbiAgICAgICAgY29uc3QgZGF0YWRvZ1NlY3JldCA9IFNNU2VjcmV0LmZyb21TZWNyZXROYW1lVjIodGhpcywgJ0RhdGFkb2dTZWNyZXQnLCBgLyR7cHJvcHMuZGVwbG95bWVudEVudn0vcGxhdGZvcm0vZGF0YWRvZ19lY3NgKVxuICAgICAgICBjb25zdCBkYXRhZG9nQ29udGFpbmVyRGVmID0gdGFza0RlZi5hZGRDb250YWluZXIoJ0RhdGFkb2dDb250YWluZXInLCB7XG4gICAgICAgICAgICBjb250YWluZXJOYW1lOiBgZGF0YWRvZy1hZ2VudC0ke21haW5Db250YWluZXJOYW1lfWAsXG4gICAgICAgICAgICBpbWFnZTogQ29udGFpbmVySW1hZ2UuZnJvbUVjclJlcG9zaXRvcnkoXG4gICAgICAgICAgICAgICAgUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeUF0dHJpYnV0ZXModGhpcywgJ0RhdGFkb2dSZXBvc2l0b3J5Jywge1xuICAgICAgICAgICAgICAgICAgICByZXBvc2l0b3J5QXJuOiBSZXBvc2l0b3J5LmFybkZvckxvY2FsUmVwb3NpdG9yeShcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFkb2dJbWFnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnYuZWNyQWNjb3VudFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICByZXBvc2l0b3J5TmFtZTogRGF0YWRvZ0ltYWdlXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgRGF0YWRvZ0ltYWdlVGFnXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbG9nZ2luZzogTG9nRHJpdmVyLmF3c0xvZ3Moe1xuICAgICAgICAgICAgICAgIGxvZ0dyb3VwOiBtYWluTG9nR3JvdXAsXG4gICAgICAgICAgICAgICAgc3RyZWFtUHJlZml4OiAnZGF0YWRvZydcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgcG9ydE1hcHBpbmdzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXJQb3J0OiA4MTI1LFxuICAgICAgICAgICAgICAgICAgICBob3N0UG9ydDogODEyNSxcbiAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w6IFByb3RvY29sLlVEUFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBob3N0UG9ydDogODEyNixcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyUG9ydDogODEyNixcbiAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w6IFByb3RvY29sLlRDUFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBzZWNyZXRzOiB7XG4gICAgICAgICAgICAgICAgRERfQVBJX0tFWTogU2VjcmV0LmZyb21TZWNyZXRzTWFuYWdlcihkYXRhZG9nU2VjcmV0KVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgLi4ucHJvcHMuZW52VmFycz8uZGF0YURvZyxcbiAgICAgICAgICAgICAgICBERF9BUE1fRU5BQkxFRDogJ3RydWUnLFxuICAgICAgICAgICAgICAgIEREX0FQTV9OT05fTE9DQUxfVFJBRkZJQzogJ3RydWUnLFxuICAgICAgICAgICAgICAgIEREX0FQTV9SRUNFSVZFUl9QT1JUOiAnODEyNicsXG4gICAgICAgICAgICAgICAgRERfRE9DS0VSX0xBQkVMU19BU19UQUdTOiBge1wiJHtyZXZlcnNlRG9tYWluTmFtZShlbnYuaW50ZXJuYWxMYil9LmFsYi4ke3Byb3BzLmltYWdlTmFtZX0uc2VydmljZV9uYW1lXCI6XCJzZXJ2aWNlX25hbWVcIixcIiR7cmV2ZXJzZURvbWFpbk5hbWUoZW52LmludGVybmFsTGIpfS5hbGIuJHtwcm9wcy5pbWFnZU5hbWV9LmdpdGh1Yl90YWdcIjpcImdpdGh1Yl90YWdcIn1gLFxuICAgICAgICAgICAgICAgIEREX0RPR1NUQVRTRF9OT05fTE9DQUxfVFJBRkZJQzogJ3RydWUnLFxuICAgICAgICAgICAgICAgIEREX0RPR1NUQVRTRF9QT1JUOiAnODEyNScsXG4gICAgICAgICAgICAgICAgRERfTE9HU19FTkFCTEVEOiAndHJ1ZScsXG4gICAgICAgICAgICAgICAgRERfU0lURTogJ2RhdGFkb2docS5jb20nLFxuICAgICAgICAgICAgICAgIEREX1RBR1M6IGdldERhdGFEb2dUYWdzKHsgLi4ucHJvcHMuZGRUYWdzQ29uZmlnLCBlbnY6IHByb3BzLmRlcGxveW1lbnRFbnYgfSwgeyBjbHVzdGVyOiBjbHVzdGVyTmFtZSB9KSxcbiAgICAgICAgICAgICAgICBFQ1NfRkFSR0FURTogJ3RydWUnXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaGVhbHRoQ2hlY2s6IHtcbiAgICAgICAgICAgICAgICBjb21tYW5kOiBbJ0NNRC1TSEVMTCcsICdhZ2VudCBoZWFsdGggfHwgZXhpdCAxJ11cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgICAgICBtYWluQ29udGFpbmVyRGVmLmFkZENvbnRhaW5lckRlcGVuZGVuY2llcyh7XG4gICAgICAgICAgICBjb250YWluZXI6IGRhdGFkb2dDb250YWluZXJEZWYsXG4gICAgICAgICAgICBjb25kaXRpb246IENvbnRhaW5lckRlcGVuZGVuY3lDb25kaXRpb24uSEVBTFRIWVxuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IGJhc2VTZXJ2aWNlQ3JlYXRpb25Qcm9wcyA9IHtcbiAgICAgICAgICAgIGFzc2lnblB1YmxpY0lwOiBmYWxzZSxcbiAgICAgICAgICAgIHRhc2tEZWZpbml0aW9uOiB0YXNrRGVmLFxuICAgICAgICAgICAgY2x1c3RlcjogQ2x1c3Rlci5mcm9tQ2x1c3RlckF0dHJpYnV0ZXModGhpcywgJ0NsdXN0ZXInLCB7XG4gICAgICAgICAgICAgICAgY2x1c3Rlck5hbWU6IHByb3BzLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgICAgIHZwYzogd2VzRGlnaXRhbFZwYyh0aGlzLCAndnBjJywgZW52UHJvcHMpLFxuICAgICAgICAgICAgICAgIHNlY3VyaXR5R3JvdXBzOiBbXVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzZXJ2aWNlTmFtZTogYCR7cHJvcHMuaWRlbnRpZmllcn0ke3Byb3BzLmRlcGxveW1lbnRFbnZ9LSR7cHJvcHMuaW1hZ2VOYW1lfWBcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IFNlcnZpY2VDbGFzcyA9IHRhc2tEZWZQcm9wcy5zZXJ2aWNlVHlwZVxuICAgICAgICBjb25zdCBzZXJ2aWNlQ3JlYXRpb25Qcm9wcyA9XG4gICAgICAgICAgICBTZXJ2aWNlQ2xhc3MgPT09IEFwcGxpY2F0aW9uTG9hZEJhbGFuY2VkRmFyZ2F0ZVNlcnZpY2VcbiAgICAgICAgICAgICAgICA/IHsgLi4uYmFzZVNlcnZpY2VDcmVhdGlvblByb3BzLCBwdWJsaWNMb2FkQmFsYW5jZXI6IGZhbHNlIH1cbiAgICAgICAgICAgICAgICA6IHsgLi4uYmFzZVNlcnZpY2VDcmVhdGlvblByb3BzIH1cbiAgICAgICAgY29uc3QgZmFyZ2F0ZVNlcnZpY2UgPSBuZXcgU2VydmljZUNsYXNzKHRoaXMsICdTZXJ2aWNlJywgc2VydmljZUNyZWF0aW9uUHJvcHMpXG5cbiAgICAgICAgY29uc3Qgc2NhbGVQcm9wcyA9IHtcbiAgICAgICAgICAgIG1heENhcGFjaXR5OiBwcm9wcy5hdXRvc2NhbGluZz8ubWF4ID8/IDMsXG4gICAgICAgICAgICBtaW5DYXBhY2l0eTogcHJvcHMuYXV0b3NjYWxpbmc/Lm1pbiA/PyAxXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzY2FsaW5nID0gZmFyZ2F0ZVNlcnZpY2UgaW5zdGFuY2VvZiBGYXJnYXRlU2VydmljZSA/IGZhcmdhdGVTZXJ2aWNlLmF1dG9TY2FsZVRhc2tDb3VudChzY2FsZVByb3BzKSA6IGZhcmdhdGVTZXJ2aWNlLnNlcnZpY2UuYXV0b1NjYWxlVGFza0NvdW50KHNjYWxlUHJvcHMpXG4gICAgICAgIHN3aXRjaCAocHJvcHMuYXV0b3NjYWxpbmc/Lm1ldHJpYykge1xuICAgICAgICBjYXNlICdDUFUnOlxuICAgICAgICAgICAgc2NhbGluZy5zY2FsZU9uQ3B1VXRpbGl6YXRpb24oJ0NQVVNjYWxpbmcnLCB7XG4gICAgICAgICAgICAgICAgc2NhbGVJbkNvb2xkb3duOiBwcm9wcy5hdXRvc2NhbGluZy5zY2FsZUluQ29vbGRvd24sXG4gICAgICAgICAgICAgICAgc2NhbGVPdXRDb29sZG93bjogcHJvcHMuYXV0b3NjYWxpbmcuc2NhbGVPdXRDb29sZG93bixcbiAgICAgICAgICAgICAgICB0YXJnZXRVdGlsaXphdGlvblBlcmNlbnQ6IHByb3BzLmF1dG9zY2FsaW5nLnRhcmdldFZhbHVlXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnTWVtb3J5JzpcbiAgICAgICAgICAgIHNjYWxpbmcuc2NhbGVPbk1lbW9yeVV0aWxpemF0aW9uKCdNZW1vcnlTY2FsaW5nJywge1xuICAgICAgICAgICAgICAgIHNjYWxlSW5Db29sZG93bjogcHJvcHMuYXV0b3NjYWxpbmcuc2NhbGVJbkNvb2xkb3duLFxuICAgICAgICAgICAgICAgIHNjYWxlT3V0Q29vbGRvd246IHByb3BzLmF1dG9zY2FsaW5nLnNjYWxlT3V0Q29vbGRvd24sXG4gICAgICAgICAgICAgICAgdGFyZ2V0VXRpbGl6YXRpb25QZXJjZW50OiBwcm9wcy5hdXRvc2NhbGluZy50YXJnZXRWYWx1ZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBzY2FsaW5nLnNjYWxlT25DcHVVdGlsaXphdGlvbignQ1BVU2NhbGluZycsIHtcbiAgICAgICAgICAgICAgICBzY2FsZUluQ29vbGRvd246IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICAgICAgICAgICAgc2NhbGVPdXRDb29sZG93bjogRHVyYXRpb24ubWludXRlcygxKSxcbiAgICAgICAgICAgICAgICB0YXJnZXRVdGlsaXphdGlvblBlcmNlbnQ6IDgwXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRkU2VjcmV0UG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBhY3Rpb25zOiBbJ3NlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlJ10sXG4gICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgIHJlc291cmNlczogW2RhdGFkb2dTZWNyZXQuc2VjcmV0QXJuXSxcbiAgICAgICAgICAgIHNpZDogJ2RhdGFkb2dzZWNyZXQnXG4gICAgICAgIH0pXG4gICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvVGFza1JvbGVQb2xpY3koZGRTZWNyZXRQb2xpY3kpXG5cbiAgICAgICAgY29uc3QgZGRLbXNQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAna21zOkRlY3J5cHQnLFxuICAgICAgICAgICAgICAgICdrbXM6RGVzY3JpYmVLZXknLFxuICAgICAgICAgICAgICAgICdrbXM6R2VuZXJhdGVEYXRhS2V5J1xuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbU3RyaW5nUGFyYW1ldGVyLnZhbHVlRm9yU3RyaW5nUGFyYW1ldGVyKFxuICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgYC8ke3Byb3BzLmRlcGxveW1lbnRFbnZ9LyR7cHJvcHMuY2x1c3Rlck5hbWV9L0VDUy8ke3Byb3BzLmNsdXN0ZXJOYW1lfWApXSxcbiAgICAgICAgICAgIHNpZDogJ2NsdXN0ZXJrbXNrZXknXG4gICAgICAgIH0pXG4gICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvRXhlY3V0aW9uUm9sZVBvbGljeShkZEttc1BvbGljeSlcbiAgICAgICAgZmFyZ2F0ZVNlcnZpY2UudGFza0RlZmluaXRpb24uYWRkVG9UYXNrUm9sZVBvbGljeShkZEttc1BvbGljeSlcblxuICAgICAgICBpZiAocHJvcHMubXNrKSB7XG4gICAgICAgICAgICBjb25zdCBtc2tDbHVzdGVyUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uczogWydrYWZrYS1jbHVzdGVyOkNvbm5lY3QnXSxcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtlbnYubXNrQ2x1c3RlckFybl0sXG4gICAgICAgICAgICAgICAgc2lkOiAna2x1c3RlcmNvbm5lY3QnXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgZmFyZ2F0ZVNlcnZpY2UudGFza0RlZmluaXRpb24uYWRkVG9UYXNrUm9sZVBvbGljeShtc2tDbHVzdGVyUG9saWN5KVxuXG4gICAgICAgICAgICBpZiAocHJvcHMubXNrLmNvbnN1bWVyVG9waWNzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtc2tDb25zdW1lclRvcGljUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICdrYWZrYS1jbHVzdGVyOkRlc2NyaWJlVG9waWMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2thZmthLWNsdXN0ZXI6UmVhZERhdGEnXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IHByb3BzLm1zay5jb25zdW1lclRvcGljcy5tYXAodG9waWMgPT4gYCR7ZW52Lm1za0NsdXN0ZXJBcm4ucmVwbGFjZSgnY2x1c3RlcicsICd0b3BpYycpfS8ke3RvcGljfWApLFxuICAgICAgICAgICAgICAgICAgICBzaWQ6ICdtc2tjb25zdW1lcnRvcGljcydcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvVGFza1JvbGVQb2xpY3kobXNrQ29uc3VtZXJUb3BpY1BvbGljeSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb3BzLm1zay5jb25zdW1lckdyb3Vwcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNrQ29uc3VtZXJHcm91cFBvbGljeSA9IG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAna2Fma2EtY2x1c3RlcjpBbHRlckdyb3VwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrYWZrYS1jbHVzdGVyOkRlc2NyaWJlR3JvdXAnXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IHByb3BzLm1zay5jb25zdW1lckdyb3Vwcy5tYXAoZ3JvdXAgPT4gYCR7ZW52Lm1za0NsdXN0ZXJBcm4ucmVwbGFjZSgnY2x1c3RlcicsICdncm91cCcpfS8ke2dyb3VwfWApLFxuICAgICAgICAgICAgICAgICAgICBzaWQ6ICdtc2tjb25zdW1lcmdyb3VwcydcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvVGFza1JvbGVQb2xpY3kobXNrQ29uc3VtZXJHcm91cFBvbGljeSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb3BzLm1zay5wcm9kdWNlclRvcGljcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNrUHJvZHVjZXJQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2thZmthLWNsdXN0ZXI6RGVzY3JpYmVUb3BpYycsXG4gICAgICAgICAgICAgICAgICAgICAgICAna2Fma2EtY2x1c3RlcjpXcml0ZURhdGEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2thZmthLWNsdXN0ZXI6V3JpdGVEYXRhSWRlbXBvdGVudGx5J1xuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBwcm9wcy5tc2sucHJvZHVjZXJUb3BpY3MubWFwKHRvcGljID0+IGAke2Vudi5tc2tDbHVzdGVyQXJuLnJlcGxhY2UoJ2NsdXN0ZXInLCAndG9waWMnKX0vJHt0b3BpY31gKSxcbiAgICAgICAgICAgICAgICAgICAgc2lkOiAnbXNrcHJvZHVjZXInXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBmYXJnYXRlU2VydmljZS50YXNrRGVmaW5pdGlvbi5hZGRUb1Rhc2tSb2xlUG9saWN5KG1za1Byb2R1Y2VyUG9saWN5KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGFibGVzID0gcHJvcHMuZHluYW1vPy50YWJsZU5hbWVzID8/IFtdXG4gICAgICAgIGlmICh0YWJsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgZHluYW1vUmVzb3VyY2VzID0gW1xuICAgICAgICAgICAgICAgIC4uLnRhYmxlcy5tYXAodGFibGUgPT4gU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgICAgICAgICAgICAgICAgc2VydmljZTogJ2R5bmFtb2RiJyxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2U6ICd0YWJsZScsXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlTmFtZTogdGFibGVcbiAgICAgICAgICAgICAgICB9KSksXG4gICAgICAgICAgICAgICAgLi4udGFibGVzLm1hcCh0YWJsZSA9PiBTdGFjay5vZih0aGlzKS5mb3JtYXRBcm4oe1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnZHluYW1vZGInLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZTogJ3RhYmxlJyxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VOYW1lOiBgJHt0YWJsZX0vaW5kZXgvKmBcbiAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgICAgIGNvbnN0IGR5bmFtb1BvbGljeSA9IG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgJ2R5bmFtb2RiOkJhdGNoR2V0SXRlbScsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpCYXRjaFdyaXRlSXRlbScsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpDb25kaXRpb25DaGVja0l0ZW0nLFxuICAgICAgICAgICAgICAgICAgICAnZHluYW1vZGI6RGVsZXRlSXRlbScsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpEZXNjcmliZVRhYmxlJyxcbiAgICAgICAgICAgICAgICAgICAgJ2R5bmFtb2RiOkdldEl0ZW0nLFxuICAgICAgICAgICAgICAgICAgICAnZHluYW1vZGI6UHV0SXRlbScsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpRdWVyeScsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpTY2FuJyxcbiAgICAgICAgICAgICAgICAgICAgJ2R5bmFtb2RiOlVwZGF0ZUl0ZW0nXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IGR5bmFtb1Jlc291cmNlcyxcbiAgICAgICAgICAgICAgICBzaWQ6ICdkeW5hbW8nXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgZmFyZ2F0ZVNlcnZpY2UudGFza0RlZmluaXRpb24uYWRkVG9UYXNrUm9sZVBvbGljeShkeW5hbW9Qb2xpY3kpXG5cbiAgICAgICAgICAgIGlmIChwcm9wcy5keW5hbW8/LmFkZEtleXNUb1Rhc2tSb2xlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHluYW1vS21zUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6Q3JlYXRlR3JhbnQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpEZWNyeXB0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6RGVzY3JpYmVLZXknLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpFbmNyeXB0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6R2VuZXJhdGVEYXRhS2V5KicsXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOlJlRW5jcnlwdConXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IHRhYmxlcy5tYXAodGFibGUgPT4gU3RyaW5nUGFyYW1ldGVyLnZhbHVlRm9yU3RyaW5nUGFyYW1ldGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAvJHtwcm9wcy5pZGVudGlmaWVyfSR7cHJvcHMuZGVwbG95bWVudEVudn0vJHtwcm9wcy5pbWFnZU5hbWV9L0RZTkFNT0RCLyR7dGFibGV9YFxuICAgICAgICAgICAgICAgICAgICApKSxcbiAgICAgICAgICAgICAgICAgICAgc2lkOiAnZHluYW1va21zJ1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgZmFyZ2F0ZVNlcnZpY2UudGFza0RlZmluaXRpb24uYWRkVG9UYXNrUm9sZVBvbGljeShkeW5hbW9LbXNQb2xpY3kpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZWNyZXRQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGFjdGlvbnM6IFsnc2VjcmV0c21hbmFnZXI6R2V0U2VjcmV0VmFsdWUnXSxcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnc2VjcmV0c21hbmFnZXInLFxuICAgICAgICAgICAgICAgIHJlc291cmNlOiAnc2VjcmV0OicsXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VOYW1lOiBgJHtwcm9wcy5pZGVudGlmaWVyfSR7cHJvcHMuZGVwbG95bWVudEVudn0vJHtwcm9wcy5pbWFnZU5hbWV9LypgXG4gICAgICAgICAgICB9KV0sXG4gICAgICAgICAgICBzaWQ6ICdzZWNyZXRzJ1xuICAgICAgICB9KVxuICAgICAgICBmYXJnYXRlU2VydmljZS50YXNrRGVmaW5pdGlvbi5hZGRUb0V4ZWN1dGlvblJvbGVQb2xpY3koc2VjcmV0UG9saWN5KVxuICAgICAgICBmYXJnYXRlU2VydmljZS50YXNrRGVmaW5pdGlvbi5hZGRUb1Rhc2tSb2xlUG9saWN5KHNlY3JldFBvbGljeSlcblxuICAgICAgICBjb25zdCBzZWNyZXRzID0gcHJvcHMudGFza1NlY3JldHM/LmV4dGVybmFsU2VjcmV0Q29uZmlnID8/IFtdXG4gICAgICAgIGlmIChzZWNyZXRzLmxlbmd0aCA+IDAgJiYgcHJvcHMudGFza1NlY3JldHM/LmFkZEtleXNUb1Rhc2tSb2xlKSB7XG4gICAgICAgICAgICBjb25zdCBzZWNyZXRzS21zUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICAna21zOkNyZWF0ZUdyYW50JyxcbiAgICAgICAgICAgICAgICAgICAgJ2ttczpEZWNyeXB0JyxcbiAgICAgICAgICAgICAgICAgICAgJ2ttczpEZXNjcmliZUtleScsXG4gICAgICAgICAgICAgICAgICAgICdrbXM6RW5jcnlwdCcsXG4gICAgICAgICAgICAgICAgICAgICdrbXM6R2VuZXJhdGVEYXRhS2V5KicsXG4gICAgICAgICAgICAgICAgICAgICdrbXM6UmVFbmNyeXB0KidcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogc2VjcmV0cy5tYXAoc2VjcmV0ID0+IFN0cmluZ1BhcmFtZXRlci52YWx1ZUZvclN0cmluZ1BhcmFtZXRlcihcbiAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgYC8ke3Byb3BzLmlkZW50aWZpZXJ9JHtwcm9wcy5kZXBsb3ltZW50RW52fS8ke3Byb3BzLmltYWdlTmFtZX0vRVhURVJOQUwvJHtzZWNyZXQubGFzdFBhcnRPZlNlY3JldE5hbWV9YFxuICAgICAgICAgICAgICAgICkpLFxuICAgICAgICAgICAgICAgIHNpZDogJ2V4dGVybmFsc2VjcmV0c2ttcydcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBmYXJnYXRlU2VydmljZS50YXNrRGVmaW5pdGlvbi5hZGRUb0V4ZWN1dGlvblJvbGVQb2xpY3koc2VjcmV0c0ttc1BvbGljeSlcbiAgICAgICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvVGFza1JvbGVQb2xpY3koc2VjcmV0c0ttc1BvbGljeSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNzbVBhcmFtUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBhY3Rpb25zOiBbJ3NzbTpHZXRQYXJhbWV0ZXInLCAnc3NtOkdldFBhcmFtZXRlcnMnXSxcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnc3NtJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZTogJ3BhcmFtZXRlcicsXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VOYW1lOiBgJHtwcm9wcy5pZGVudGlmaWVyfSR7cHJvcHMuZGVwbG95bWVudEVudn0vJHtwcm9wcy5pbWFnZU5hbWV9LypgXG4gICAgICAgICAgICB9KV0sXG4gICAgICAgICAgICBzaWQ6ICdzc21wYXJhbXMnXG4gICAgICAgIH0pXG4gICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvRXhlY3V0aW9uUm9sZVBvbGljeShzc21QYXJhbVBvbGljeSlcbiAgICAgICAgZmFyZ2F0ZVNlcnZpY2UudGFza0RlZmluaXRpb24uYWRkVG9UYXNrUm9sZVBvbGljeShzc21QYXJhbVBvbGljeSlcblxuICAgICAgICBjb25zdCBrZXlQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGFjdGlvbnM6IFsna21zOkRlY3J5cHQnXSxcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbc2VydmljZUttc0tleS5rZXkua2V5QXJuXSxcbiAgICAgICAgICAgIHNpZDogJ2ZhcmdhdGVrZXknXG4gICAgICAgIH0pXG4gICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvRXhlY3V0aW9uUm9sZVBvbGljeShrZXlQb2xpY3kpXG4gICAgICAgIGZhcmdhdGVTZXJ2aWNlLnRhc2tEZWZpbml0aW9uLmFkZFRvVGFza1JvbGVQb2xpY3koa2V5UG9saWN5KVxuXG4gICAgICAgIHRoaXMuX3NlcnZpY2UgPSBmYXJnYXRlU2VydmljZVxuICAgIH1cbn1cbiJdfQ==