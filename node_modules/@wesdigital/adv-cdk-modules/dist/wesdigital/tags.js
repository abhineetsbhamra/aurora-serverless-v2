"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AddInfraTags = exports.addInfraTags = exports.addStackTags = exports.addTags = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cdkRoot = 'cdk/';
function addTags(construct, tags) {
    const tagsObj = aws_cdk_lib_1.Tags.of(construct);
    Object
        .entries(tags)
        .filter(([_, val]) => Boolean(val))
        .forEach(([key, val]) => {
        tagsObj.add(key, val);
    });
}
exports.addTags = addTags;
/**
 * @deprecated use {@link AddInfraTags} Aspect instead
 *  */
function addStackTags(stack, config) {
    addInfraTags(stack, stack, config);
}
exports.addStackTags = addStackTags;
function addInfraTags(stack, construct, config) {
    const tags = resolveInfraTags(stack, config);
    if (!aws_cdk_lib_1.TagManager.isTaggable(construct)) {
        throw new Error(`Cannot tag construct ${construct.node.path}`);
    }
    addTags(construct, tags);
}
exports.addInfraTags = addInfraTags;
function resolveInfraTags(stack, config) {
    let gitSource;
    if (config.gitSource) {
        gitSource = config.gitSource;
    }
    else if (process.env.GITHUB_REPOSITORY) {
        if (stack.filename) {
            gitSource = `${process.env.GITHUB_REPOSITORY}/${stack.filename.slice(stack.filename.indexOf(cdkRoot))}`;
        }
        else {
            gitSource = process.env.GITHUB_REPOSITORY;
        }
    }
    else {
        gitSource = 'no-repository-found'; // Default, for running `cdk synth` locally
    }
    return {
        env: config.env,
        service: config.service || undefined,
        'git-source': gitSource,
        'business-unit': 'advantage',
        'created-by': config.createdBy,
        domain: config.domain,
        Name: config.name,
        stackname: stack.stackName
    };
}
/* Adds tags for the AddInfraTags aspect
 */
function addAspectTags(taggable, tags) {
    Object
        .entries(tags)
        .filter(([_, val]) => Boolean(val))
        .forEach(([key, val]) => {
        taggable.tags.setTag(key, val);
    });
}
/**
 * Aspect to add platform mandated tags
 *  - If applying to a stack, use `Aspects.of(stack).add(new AddInfraTags({ ...config... })`
 *  - If applying to a stage, use `Aspects.of(this).add(new AddInfraTags({ ...config... })` from within the Stage constructor
 * If you have multiple Stacks in the same repository, it is recommended to expose a `public filename = __filename`. This will be automatically appended to the `GITHUB_REPOSITORY`, to clarify your `git-source` tag
 */
class AddInfraTags {
    constructor(config, extraTags) {
        this.config = config;
        this.extraTags = extraTags !== null && extraTags !== void 0 ? extraTags : {};
    }
    visit(node) {
        if (aws_cdk_lib_1.TagManager.isTaggable(node)) {
            const name = this.resolveNodeName(node);
            const stack = node.node.scopes.reverse().find(c => aws_cdk_lib_1.Stack.isStack(c));
            if (!stack) {
                aws_cdk_lib_1.Annotations.of(node).addError(`Could not resolve stack for node ${node.node.path}`);
                return;
            }
            const infraTags = resolveInfraTags(stack, {
                ...this.config,
                name
            });
            addAspectTags(node, { ...infraTags, ...this.extraTags });
        }
    }
    resolveNodeName(node) {
        if (node.node.scope && !aws_cdk_lib_1.Stack.isStack(node.node.scope)) {
            // Taggable is typically on the Resource underneath a L2 Construct, so go up 1 if possible.
            return node.node.scope.node.id;
        }
        return node.node.id;
    }
}
exports.AddInfraTags = AddInfraTags;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi93ZXNkaWdpdGFsL3RhZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsNkNBQXNGO0FBR3RGLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQTtBQUV0QixTQUFnQixPQUFPLENBQUUsU0FBcUIsRUFBRSxJQUF1QjtJQUNuRSxNQUFNLE9BQU8sR0FBRyxrQkFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUNsQyxNQUFNO1NBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQztTQUNiLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDbEMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRTtRQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFJLENBQUMsQ0FBQTtJQUMxQixDQUFDLENBQUMsQ0FBQTtBQUNWLENBQUM7QUFSRCwwQkFRQztBQWdCRDs7TUFFTTtBQUNOLFNBQWdCLFlBQVksQ0FBRSxLQUFZLEVBQUUsTUFBdUI7SUFDL0QsWUFBWSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7QUFDdEMsQ0FBQztBQUZELG9DQUVDO0FBRUQsU0FBZ0IsWUFBWSxDQUFFLEtBQVksRUFBRSxTQUFxQixFQUFFLE1BQXVCO0lBQ3RGLE1BQU0sSUFBSSxHQUFHLGdCQUFnQixDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUU1QyxJQUFJLENBQUMsd0JBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFBO0tBQ2pFO0lBRUQsT0FBTyxDQUFDLFNB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RUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO1NBQzNEO0lBQ0wsQ0FBQztJQUVELGVBQWUsQ0FBRSxJQUFnQjtRQUM3QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsbUJBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNwRCwyRkFBMkY7WUFDM0YsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFBO1NBQ2pDO1FBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQTtJQUN2QixDQUFDO0NBQ0o7QUF0Q0Qsb0NBc0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVwbG95bWVudEVudiB9IGZyb20gJy4vYWNjb3VudHMnXG5pbXBvcnQgeyBJQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cydcbmltcG9ydCB7IEFubm90YXRpb25zLCBJQXNwZWN0LCBJVGFnZ2FibGUsIFN0YWNrLCBUYWdNYW5hZ2VyLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInXG5cbnR5cGUgT3B0aW9uYWxTdHJpbmdNYXAgPSB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IHVuZGVmaW5lZCB9XG5jb25zdCBjZGtSb290ID0gJ2Nkay8nXG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRUYWdzIChjb25zdHJ1Y3Q6IElDb25zdHJ1Y3QsIHRhZ3M6IE9wdGlvbmFsU3RyaW5nTWFwKSB7XG4gICAgY29uc3QgdGFnc09iaiA9IFRhZ3Mub2YoY29uc3RydWN0KVxuICAgIE9iamVjdFxuICAgICAgICAuZW50cmllcyh0YWdzKVxuICAgICAgICAuZmlsdGVyKChbXywgdmFsXSkgPT4gQm9vbGVhbih2YWwpKVxuICAgICAgICAuZm9yRWFjaCgoW2tleSwgdmFsXSkgPT4ge1xuICAgICAgICAgICAgdGFnc09iai5hZGQoa2V5LCB2YWwhKVxuICAgICAgICB9KVxufVxuXG4vKipcbiAqIENvbmZpZ3VyZWQgYXMgcGVyIGh0dHBzOi8vd2VzZGlnaXRhbC5hdGxhc3NpYW4ubmV0L3dpa2kvc3BhY2VzL1NDRS9wYWdlcy8xNTAzMDcyMjEvQVdTK0luZnJhc3RydWN0dXJlK1RhZ3NcbiAqIEBwYXJhbSBzZXJ2aWNlIGRlZmF1bHRzIHRvIGB1bmRlZmluZWRgLCB3aGljaCB3aWxsIG9taXQgdGhlIGZpZWxkXG4gKiBAcGFyYW0gZ2l0U291cmNlIGRlZmF1bHRzIHRvIHRoZSBgR0lUSFVCX1JFUE9TSVRPUllgIGVudmlyb25tZW50IHZhcmlhYmxlLCBhbmQgYXBwZW5kZWQgYnkgdGhlIGBzdGFjay5maWxlbmFtZWAgaWYgYXZhaWxhYmxlXG4gKiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbmZyYVRhZ3NDb25maWcge1xuICBlbnY6IERlcGxveW1lbnRFbnYsXG4gIG5hbWU6IHN0cmluZyxcbiAgY3JlYXRlZEJ5OiBzdHJpbmcsXG4gIGRvbWFpbjogc3RyaW5nLFxuICBzZXJ2aWNlPzogc3RyaW5nLFxuICBnaXRTb3VyY2U/OiBzdHJpbmcsXG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgdXNlIHtAbGluayBBZGRJbmZyYVRhZ3N9IEFzcGVjdCBpbnN0ZWFkXG4gKiAgKi9cbmV4cG9ydCBmdW5jdGlvbiBhZGRTdGFja1RhZ3MgKHN0YWNrOiBTdGFjaywgY29uZmlnOiBJbmZyYVRhZ3NDb25maWcpIHtcbiAgICBhZGRJbmZyYVRhZ3Moc3RhY2ssIHN0YWNrLCBjb25maWcpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRJbmZyYVRhZ3MgKHN0YWNrOiBTdGFjaywgY29uc3RydWN0OiBJQ29uc3RydWN0LCBjb25maWc6IEluZnJhVGFnc0NvbmZpZykge1xuICAgIGNvbnN0IHRhZ3MgPSByZXNvbHZlSW5mcmFUYWdzKHN0YWNrLCBjb25maWcpXG5cbiAgICBpZiAoIVRhZ01hbmFnZXIuaXNUYWdnYWJsZShjb25zdHJ1Y3QpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHRhZyBjb25zdHJ1Y3QgJHtjb25zdHJ1Y3Qubm9kZS5wYXRofWApXG4gICAgfVxuXG4gICAgYWRkVGFncyhjb25zdHJ1Y3QsIHRhZ3MpXG59XG5cbmZ1bmN0aW9uIHJlc29sdmVJbmZyYVRhZ3MgKHN0YWNrOiBTdGFjayAmIHsgZmlsZW5hbWU/OiBzdHJpbmcgfSwgY29uZmlnOiBJbmZyYVRhZ3NDb25maWcpOiBPcHRpb25hbFN0cmluZ01hcCB7XG4gICAgbGV0IGdpdFNvdXJjZTogc3RyaW5nXG4gICAgaWYgKGNvbmZpZy5naXRTb3VyY2UpIHtcbiAgICAgICAgZ2l0U291cmNlID0gY29uZmlnLmdpdFNvdXJjZVxuICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuR0lUSFVCX1JFUE9TSVRPUlkpIHtcbiAgICAgICAgaWYgKHN0YWNrLmZpbGVuYW1lKSB7XG4gICAgICAgICAgICBnaXRTb3VyY2UgPSBgJHtwcm9jZXNzLmVudi5HSVRIVUJfUkVQT1NJVE9SWX0vJHtzdGFjay5maWxlbmFtZS5zbGljZShzdGFjay5maWxlbmFtZS5pbmRleE9mKGNka1Jvb3QpKX1gXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBnaXRTb3VyY2UgPSBwcm9jZXNzLmVudi5HSVRIVUJfUkVQT1NJVE9SWVxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZ2l0U291cmNlID0gJ25vLXJlcG9zaXRvcnktZm91bmQnIC8vIERlZmF1bHQsIGZvciBydW5uaW5nIGBjZGsgc3ludGhgIGxvY2FsbHlcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBlbnY6IGNvbmZpZy5lbnYsXG4gICAgICAgIHNlcnZpY2U6IGNvbmZpZy5zZXJ2aWNlIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgJ2dpdC1zb3VyY2UnOiBnaXRTb3VyY2UsXG4gICAgICAgICdidXNpbmVzcy11bml0JzogJ2FkdmFudGFnZScsXG4gICAgICAgICdjcmVhdGVkLWJ5JzogY29uZmlnLmNyZWF0ZWRCeSxcbiAgICAgICAgZG9tYWluOiBjb25maWcuZG9tYWluLFxuICAgICAgICBOYW1lOiBjb25maWcubmFtZSxcbiAgICAgICAgc3RhY2tuYW1lOiBzdGFjay5zdGFja05hbWVcbiAgICB9XG59XG5cbi8qIEFkZHMgdGFncyBmb3IgdGhlIEFkZEluZnJhVGFncyBhc3BlY3RcbiAqL1xuZnVuY3Rpb24gYWRkQXNwZWN0VGFncyAodGFnZ2FibGU6IElUYWdnYWJsZSwgdGFnczogT3B0aW9uYWxTdHJpbmdNYXApIHtcbiAgICBPYmplY3RcbiAgICAgICAgLmVudHJpZXModGFncylcbiAgICAgICAgLmZpbHRlcigoW18sIHZhbF0pID0+IEJvb2xlYW4odmFsKSlcbiAgICAgICAgLmZvckVhY2goKFtrZXksIHZhbF0pID0+IHtcbiAgICAgICAgICAgIHRhZ2dhYmxlLnRhZ3Muc2V0VGFnKGtleSwgdmFsISlcbiAgICAgICAgfSlcbn1cblxuLyoqXG4gKiBBc3BlY3QgdG8gYWRkIHBsYXRmb3JtIG1hbmRhdGVkIHRhZ3NcbiAqICAtIElmIGFwcGx5aW5nIHRvIGEgc3RhY2ssIHVzZSBgQXNwZWN0cy5vZihzdGFjaykuYWRkKG5ldyBBZGRJbmZyYVRhZ3MoeyAuLi5jb25maWcuLi4gfSlgXG4gKiAgLSBJZiBhcHBseWluZyB0byBhIHN0YWdlLCB1c2UgYEFzcGVjdHMub2YodGhpcykuYWRkKG5ldyBBZGRJbmZyYVRhZ3MoeyAuLi5jb25maWcuLi4gfSlgIGZyb20gd2l0aGluIHRoZSBTdGFnZSBjb25zdHJ1Y3RvclxuICogSWYgeW91IGhhdmUgbXVsdGlwbGUgU3RhY2tzIGluIHRoZSBzYW1lIHJlcG9zaXRvcnksIGl0IGlzIHJlY29tbWVuZGVkIHRvIGV4cG9zZSBhIGBwdWJsaWMgZmlsZW5hbWUgPSBfX2ZpbGVuYW1lYC4gVGhpcyB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgYXBwZW5kZWQgdG8gdGhlIGBHSVRIVUJfUkVQT1NJVE9SWWAsIHRvIGNsYXJpZnkgeW91ciBgZ2l0LXNvdXJjZWAgdGFnXG4gKi9cbmV4cG9ydCBjbGFzcyBBZGRJbmZyYVRhZ3MgaW1wbGVtZW50cyBJQXNwZWN0IHtcbiAgICBjb25maWc6IE9taXQ8SW5mcmFUYWdzQ29uZmlnLCAnbmFtZSc+XG4gICAgZXh0cmFUYWdzOiBPcHRpb25hbFN0cmluZ01hcFxuXG4gICAgY29uc3RydWN0b3IgKGNvbmZpZzogT21pdDxJbmZyYVRhZ3NDb25maWcsICduYW1lJz4sIGV4dHJhVGFncz86IE9wdGlvbmFsU3RyaW5nTWFwKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnXG4gICAgICAgIHRoaXMuZXh0cmFUYWdzID0gZXh0cmFUYWdzID8/IHt9XG4gICAgfVxuXG4gICAgdmlzaXQgKG5vZGU6IElDb25zdHJ1Y3QpOiB2b2lkIHtcbiAgICAgICAgaWYgKFRhZ01hbmFnZXIuaXNUYWdnYWJsZShub2RlKSkge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5vZGVOYW1lKG5vZGUpXG5cbiAgICAgICAgICAgIGNvbnN0IHN0YWNrID0gbm9kZS5ub2RlLnNjb3Blcy5yZXZlcnNlKCkuZmluZChjID0+IFN0YWNrLmlzU3RhY2soYykpIGFzIFN0YWNrXG4gICAgICAgICAgICBpZiAoIXN0YWNrKSB7XG4gICAgICAgICAgICAgICAgQW5ub3RhdGlvbnMub2Yobm9kZSkuYWRkRXJyb3IoYENvdWxkIG5vdCByZXNvbHZlIHN0YWNrIGZvciBub2RlICR7bm9kZS5ub2RlLnBhdGh9YClcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgaW5mcmFUYWdzID0gcmVzb2x2ZUluZnJhVGFncyhcbiAgICAgICAgICAgICAgICBzdGFjayxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuY29uZmlnLFxuICAgICAgICAgICAgICAgICAgICBuYW1lXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICBhZGRBc3BlY3RUYWdzKG5vZGUsIHsgLi4uaW5mcmFUYWdzLCAuLi50aGlzLmV4dHJhVGFncyB9KVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzb2x2ZU5vZGVOYW1lIChub2RlOiBJQ29uc3RydWN0KSB7XG4gICAgICAgIGlmIChub2RlLm5vZGUuc2NvcGUgJiYgIVN0YWNrLmlzU3RhY2sobm9kZS5ub2RlLnNjb3BlKSkge1xuICAgICAgICAgICAgLy8gVGFnZ2FibGUgaXMgdHlwaWNhbGx5IG9uIHRoZSBSZXNvdXJjZSB1bmRlcm5lYXRoIGEgTDIgQ29uc3RydWN0LCBzbyBnbyB1cCAxIGlmIHBvc3NpYmxlLlxuICAgICAgICAgICAgcmV0dXJuIG5vZGUubm9kZS5zY29wZS5ub2RlLmlkXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5vZGUubm9kZS5pZFxuICAgIH1cbn1cbiJdfQ==