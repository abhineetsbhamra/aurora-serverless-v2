"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StandardKMSKey = void 0;
const aws_kms_1 = require("aws-cdk-lib/aws-kms");
const constructs_1 = require("constructs");
const wesdigital_1 = require("../wesdigital");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_ssm_1 = require("aws-cdk-lib/aws-ssm");
class StandardKMSKey extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this._props = {
            identifier: '',
            ...props
        };
        const kmsPolicy = new aws_iam_1.PolicyDocument({
            statements: [
                new aws_iam_1.PolicyStatement({
                    sid: 'Enable IAM Policies',
                    actions: [
                        'kms:*'
                    ],
                    principals: [new aws_iam_1.AccountRootPrincipal()],
                    resources: ['*']
                }),
                new aws_iam_1.PolicyStatement({
                    sid: 'Deny ScheduleKeyDeletion for all principals except github cross account roles and root account',
                    effect: aws_iam_1.Effect.DENY,
                    actions: [
                        'kms:ScheduleKeyDeletion'
                    ],
                    notPrincipals: [new aws_iam_1.AccountRootPrincipal()],
                    resources: ['*'],
                    conditions: {
                        ArnNotEquals: {
                            'aws:PrincipalArn': (0, wesdigital_1.deployerRoleArns)(this)
                        }
                    }
                }),
                new aws_iam_1.PolicyStatement({
                    sid: 'Allow github cross account roles specific kms permissions',
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'kms:UpdateAlias',
                        'kms:UntagResource',
                        'kms:TagResource',
                        'kms:ScheduleKeyDeletion',
                        'kms:RevokeGrant',
                        'kms:RetireGrant',
                        'kms:ReEncrypt*',
                        'kms:PutKeyPolicy',
                        'kms:ListResourceTags',
                        'kms:ListGrants',
                        'kms:ListAliases',
                        'kms:GetKeyRotationStatus',
                        'kms:GetKeyPolicy',
                        'kms:GenerateDataKey',
                        'kms:Encrypt',
                        'kms:EnableKeyRotation',
                        'kms:DescribeKey',
                        'kms:DeleteAlias',
                        'kms:Decrypt',
                        'kms:CreateKey',
                        'kms:CreateGrant',
                        'kms:CreateAlias'
                    ],
                    principals: [new aws_iam_1.AnyPrincipal()],
                    resources: ['*'],
                    conditions: {
                        ArnEquals: {
                            'aws:PrincipalArn': (0, wesdigital_1.deployerRoleArns)(this)
                        }
                    }
                })
            ]
        });
        this._key = new aws_kms_1.Key(this, 'KMSKey', {
            keySpec: aws_kms_1.KeySpec.SYMMETRIC_DEFAULT,
            keyUsage: aws_kms_1.KeyUsage.ENCRYPT_DECRYPT,
            alias: `${this._props.identifier}${props.deploymentEnv}-${props.keyName}`,
            policy: kmsPolicy
        });
    }
    get key() {
        return this._key;
    }
    addDynamoDBFor(principal, target) {
        this._key.addToResourcePolicy(new aws_iam_1.PolicyStatement({
            sid: 'Allow DynamoDB access to read/write to table',
            effect: aws_iam_1.Effect.ALLOW,
            actions: [
                'kms:Encrypt',
                'kms:Decrypt',
                'kms:ReEncrypt*',
                'kms:GenerateDataKey*',
                'kms:DescribeKey',
                'kms:CreateGrant'
            ],
            principals: [principal],
            resources: ['*'],
            conditions: {
                StringLike: {
                    'kms:ViaService': 'dynamodb.*.amazonaws.com'
                }
            }
        }));
        if (target) {
            new aws_ssm_1.StringParameter(this, 'DynamoSSMParam', {
                parameterName: `/${this._props.identifier}${this._props.deploymentEnv}/${target.serviceName}/DYNAMODB/${target.targetName}`,
                stringValue: this._key.keyArn
            });
        }
    }
    addSecretsManagerFor(principal) {
        this._key.addToResourcePolicy(new aws_iam_1.PolicyStatement({
            sid: 'Allow Secrets Manager access to use a secret',
            effect: aws_iam_1.Effect.ALLOW,
            actions: [
                'kms:Decrypt',
                'kms:ReEncrypt*',
                'kms:GenerateDataKey*',
                'kms:DescribeKey',
                'kms:CreateGrant'
            ],
            principals: [principal],
            resources: ['*'],
            conditions: {
                StringLike: {
                    'kms:ViaService': 'secretsmanager.*.amazonaws.com'
                }
            }
        }));
    }
    addCloudwatchLogs(logGroupNames) {
        this._key.addToResourcePolicy(new aws_iam_1.PolicyStatement({
            sid: 'AllowCloudWatchLogs',
            effect: aws_iam_1.Effect.ALLOW,
            actions: [
                'kms:Encrypt*',
                'kms:Decrypt*',
                'kms:Describe*',
                'kms:GenerateDataKey*',
                'kms:ReEncrypt*'
            ],
            principals: [new aws_iam_1.ServicePrincipal('logs.ap-southeast-2.amazonaws.com')],
            resources: ['*'],
            conditions: {
                ArnEquals: {
                    'kms:EncryptionContext:aws:logs:arn': logGroupNames.map(name => aws_cdk_lib_1.Stack.of(this).formatArn({
                        service: 'logs',
                        resource: `log-group:${name}`
                    }))
                }
            }
        }));
    }
}
exports.StandardKMSKey = StandardKMSKey;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2ttcy9rZXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaURBQTREO0FBQzVELDJDQUFzQztBQUN0Qyw4Q0FBK0Q7QUFDL0QsaURBTzRCO0FBQzVCLDZDQUFtQztBQUNuQyxpREFBcUQ7QUFhckQsTUFBYSxjQUFlLFNBQVEsc0JBQVM7SUFTekMsWUFBYSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF3QjtRQUMvRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRWhCLElBQUksQ0FBQyxNQUFNLEdBQUc7WUFDVixVQUFVLEVBQUUsRUFBRTtZQUNkLEdBQUcsS0FBSztTQUNYLENBQUE7UUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFjLENBQUM7WUFDakMsVUFBVSxFQUFFO2dCQUNSLElBQUkseUJBQWUsQ0FBQztvQkFDaEIsR0FBRyxFQUFFLHFCQUFxQjtvQkFDMUIsT0FBTyxFQUFFO3dCQUNMLE9BQU87cUJBQ1Y7b0JBQ0QsVUFBVSxFQUFFLENBQUMsSUFBSSw4QkFBb0IsRUFBRSxDQUFDO29CQUN4QyxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7aUJBQ25CLENBQUM7Z0JBQ0YsSUFBSSx5QkFBZSxDQUFDO29CQUNoQixHQUFHLEVBQUUsZ0dBQWdHO29CQUNyRyxNQUFNLEVBQUUsZ0JBQU0sQ0FBQyxJQUFJO29CQUNuQixPQUFPLEVBQUU7d0JBQ0wseUJBQXlCO3FCQUM1QjtvQkFDRCxhQUFhLEVBQUUsQ0FBQyxJQUFJLDhCQUFvQixFQUFFLENBQUM7b0JBQzNDLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztvQkFDaEIsVUFBVSxFQUFFO3dCQUNSLFlBQVksRUFBRTs0QkFDVixrQkFBa0IsRUFBRSxJQUFBLDZCQUFnQixFQUFDLElBQUksQ0FBQzt5QkFDN0M7cUJBQ0o7aUJBQ0osQ0FBQztnQkFDRixJQUFJLHlCQUFlLENBQUM7b0JBQ2hC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RUFBRSxDQUFDLEdBQUcsQ0FBQztZQUNoQixVQUFVLEVBQUU7Z0JBQ1IsVUFBVSxFQUFFO29CQUNSLGdCQUFnQixFQUFFLGdDQUFnQztpQkFDckQ7YUFDSjtTQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ1AsQ0FBQztJQUVELGlCQUFpQixDQUFFLGFBQXVCO1FBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSx5QkFBZSxDQUFDO1lBQzlDLEdBQUcsRUFBRSxxQkFBcUI7WUFDMUIsTUFBTSxFQUFFLGdCQUFNLENBQUMsS0FBSztZQUNwQixPQUFPLEVBQUU7Z0JBQ0wsY0FBYztnQkFDZCxjQUFjO2dCQUNkLGVBQWU7Z0JBQ2Ysc0JBQXNCO2dCQUN0QixnQkFBZ0I7YUFDbkI7WUFDRCxVQUFVLEVBQUUsQ0FBQyxJQUFJLDBCQUFnQixDQUFDLG1DQUFtQyxDQUFDLENBQUM7WUFDdkUsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ2hCLFVBQVUsRUFBRTtnQkFDUixTQUFTLEVBQUU7b0JBQ1Asb0NBQW9DLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLG1CQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQzt3QkFDckYsT0FBTyxFQUFFLE1BQU07d0JBQ2YsUUFBUSxFQUFFLGFBQWEsSUFBSSxFQUFFO3FCQUNoQyxDQUFDLENBQUM7aUJBQ047YUFDSjtTQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ1AsQ0FBQztDQUNKO0FBL0pELHdDQStKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtleSwgS2V5U3BlYywgS2V5VXNhZ2UgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mta21zJ1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cydcbmltcG9ydCB7IGRlcGxveWVyUm9sZUFybnMsIERlcGxveW1lbnRFbnYgfSBmcm9tICcuLi93ZXNkaWdpdGFsJ1xuaW1wb3J0IHtcbiAgICBBY2NvdW50Um9vdFByaW5jaXBhbCxcbiAgICBBbnlQcmluY2lwYWwsXG4gICAgRWZmZWN0LFxuICAgIElQcmluY2lwYWwsXG4gICAgUG9saWN5RG9jdW1lbnQsXG4gICAgUG9saWN5U3RhdGVtZW50LCBTZXJ2aWNlUHJpbmNpcGFsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nXG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJ2F3cy1jZGstbGliJ1xuaW1wb3J0IHsgU3RyaW5nUGFyYW1ldGVyIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXNzbSdcblxuZXhwb3J0IGludGVyZmFjZSBLTVNLZXlNb2R1bGVQcm9wcyB7XG4gICAga2V5TmFtZTogc3RyaW5nXG4gICAgZGVwbG95bWVudEVudjogRGVwbG95bWVudEVudlxuICAgIGlkZW50aWZpZXI/OiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBLTVNLZXlUYXJnZXRQcm9wcyB7XG4gICAgc2VydmljZU5hbWU6IHN0cmluZ1xuICAgIHRhcmdldE5hbWU6IHN0cmluZ1xufVxuXG5leHBvcnQgY2xhc3MgU3RhbmRhcmRLTVNLZXkgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAgIHByaXZhdGUgX3Byb3BzOiBLTVNLZXlNb2R1bGVQcm9wc1xuXG4gICAgZ2V0IGtleSAoKTogS2V5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2tleVxuICAgIH1cblxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2tleTogS2V5XG5cbiAgICBjb25zdHJ1Y3RvciAoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEtNU0tleU1vZHVsZVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZClcblxuICAgICAgICB0aGlzLl9wcm9wcyA9IHtcbiAgICAgICAgICAgIGlkZW50aWZpZXI6ICcnLFxuICAgICAgICAgICAgLi4ucHJvcHNcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGttc1BvbGljeSA9IG5ldyBQb2xpY3lEb2N1bWVudCh7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgICAgIHNpZDogJ0VuYWJsZSBJQU0gUG9saWNpZXMnLFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOionXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIHByaW5jaXBhbHM6IFtuZXcgQWNjb3VudFJvb3RQcmluY2lwYWwoKV0sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogWycqJ11cbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgc2lkOiAnRGVueSBTY2hlZHVsZUtleURlbGV0aW9uIGZvciBhbGwgcHJpbmNpcGFscyBleGNlcHQgZ2l0aHViIGNyb3NzIGFjY291bnQgcm9sZXMgYW5kIHJvb3QgYWNjb3VudCcsXG4gICAgICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkRFTlksXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6U2NoZWR1bGVLZXlEZWxldGlvbidcbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgbm90UHJpbmNpcGFsczogW25ldyBBY2NvdW50Um9vdFByaW5jaXBhbCgpXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgQXJuTm90RXF1YWxzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2F3czpQcmluY2lwYWxBcm4nOiBkZXBsb3llclJvbGVBcm5zKHRoaXMpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgc2lkOiAnQWxsb3cgZ2l0aHViIGNyb3NzIGFjY291bnQgcm9sZXMgc3BlY2lmaWMga21zIHBlcm1pc3Npb25zJyxcbiAgICAgICAgICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6VXBkYXRlQWxpYXMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpVbnRhZ1Jlc291cmNlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6VGFnUmVzb3VyY2UnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpTY2hlZHVsZUtleURlbGV0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6UmV2b2tlR3JhbnQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpSZXRpcmVHcmFudCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOlJlRW5jcnlwdConLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpQdXRLZXlQb2xpY3knLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpMaXN0UmVzb3VyY2VUYWdzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6TGlzdEdyYW50cycsXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOkxpc3RBbGlhc2VzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6R2V0S2V5Um90YXRpb25TdGF0dXMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpHZXRLZXlQb2xpY3knLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpHZW5lcmF0ZURhdGFLZXknLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpFbmNyeXB0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6RW5hYmxlS2V5Um90YXRpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ttczpEZXNjcmliZUtleScsXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOkRlbGV0ZUFsaWFzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6RGVjcnlwdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOkNyZWF0ZUtleScsXG4gICAgICAgICAgICAgICAgICAgICAgICAna21zOkNyZWF0ZUdyYW50JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdrbXM6Q3JlYXRlQWxpYXMnXSxcbiAgICAgICAgICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBBbnlQcmluY2lwYWwoKV0sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIEFybkVxdWFsczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhd3M6UHJpbmNpcGFsQXJuJzogZGVwbG95ZXJSb2xlQXJucyh0aGlzKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLl9rZXkgPSBuZXcgS2V5KHRoaXMsICdLTVNLZXknLCB7XG4gICAgICAgICAgICBrZXlTcGVjOiBLZXlTcGVjLlNZTU1FVFJJQ19ERUZBVUxULFxuICAgICAgICAgICAga2V5VXNhZ2U6IEtleVVzYWdlLkVOQ1JZUFRfREVDUllQVCxcbiAgICAgICAgICAgIGFsaWFzOiBgJHt0aGlzLl9wcm9wcy5pZGVudGlmaWVyfSR7cHJvcHMuZGVwbG95bWVudEVudn0tJHtwcm9wcy5rZXlOYW1lfWAsXG4gICAgICAgICAgICBwb2xpY3k6IGttc1BvbGljeVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGFkZER5bmFtb0RCRm9yIChwcmluY2lwYWw6IElQcmluY2lwYWwsIHRhcmdldD86IEtNU0tleVRhcmdldFByb3BzKSB7XG4gICAgICAgIHRoaXMuX2tleS5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgc2lkOiAnQWxsb3cgRHluYW1vREIgYWNjZXNzIHRvIHJlYWQvd3JpdGUgdG8gdGFibGUnLFxuICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgJ2ttczpFbmNyeXB0JyxcbiAgICAgICAgICAgICAgICAna21zOkRlY3J5cHQnLFxuICAgICAgICAgICAgICAgICdrbXM6UmVFbmNyeXB0KicsXG4gICAgICAgICAgICAgICAgJ2ttczpHZW5lcmF0ZURhdGFLZXkqJyxcbiAgICAgICAgICAgICAgICAna21zOkRlc2NyaWJlS2V5JyxcbiAgICAgICAgICAgICAgICAna21zOkNyZWF0ZUdyYW50J1xuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHByaW5jaXBhbHM6IFtwcmluY2lwYWxdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBTdHJpbmdMaWtlOiB7XG4gICAgICAgICAgICAgICAgICAgICdrbXM6VmlhU2VydmljZSc6ICdkeW5hbW9kYi4qLmFtYXpvbmF3cy5jb20nXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KSlcblxuICAgICAgICBpZiAodGFyZ2V0KSB7XG4gICAgICAgICAgICBuZXcgU3RyaW5nUGFyYW1ldGVyKHRoaXMsICdEeW5hbW9TU01QYXJhbScsIHtcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJOYW1lOiBgLyR7dGhpcy5fcHJvcHMuaWRlbnRpZmllcn0ke3RoaXMuX3Byb3BzLmRlcGxveW1lbnRFbnZ9LyR7dGFyZ2V0LnNlcnZpY2VOYW1lfS9EWU5BTU9EQi8ke3RhcmdldC50YXJnZXROYW1lfWAsXG4gICAgICAgICAgICAgICAgc3RyaW5nVmFsdWU6IHRoaXMuX2tleS5rZXlBcm5cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRTZWNyZXRzTWFuYWdlckZvciAocHJpbmNpcGFsOiBJUHJpbmNpcGFsKSB7XG4gICAgICAgIHRoaXMuX2tleS5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgc2lkOiAnQWxsb3cgU2VjcmV0cyBNYW5hZ2VyIGFjY2VzcyB0byB1c2UgYSBzZWNyZXQnLFxuICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgJ2ttczpEZWNyeXB0JyxcbiAgICAgICAgICAgICAgICAna21zOlJlRW5jcnlwdConLFxuICAgICAgICAgICAgICAgICdrbXM6R2VuZXJhdGVEYXRhS2V5KicsXG4gICAgICAgICAgICAgICAgJ2ttczpEZXNjcmliZUtleScsXG4gICAgICAgICAgICAgICAgJ2ttczpDcmVhdGVHcmFudCdcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBwcmluY2lwYWxzOiBbcHJpbmNpcGFsXSxcbiAgICAgICAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgICAgICAgICBjb25kaXRpb25zOiB7XG4gICAgICAgICAgICAgICAgU3RyaW5nTGlrZToge1xuICAgICAgICAgICAgICAgICAgICAna21zOlZpYVNlcnZpY2UnOiAnc2VjcmV0c21hbmFnZXIuKi5hbWF6b25hd3MuY29tJ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpXG4gICAgfVxuXG4gICAgYWRkQ2xvdWR3YXRjaExvZ3MgKGxvZ0dyb3VwTmFtZXM6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuX2tleS5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgc2lkOiAnQWxsb3dDbG91ZFdhdGNoTG9ncycsXG4gICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAna21zOkVuY3J5cHQqJyxcbiAgICAgICAgICAgICAgICAna21zOkRlY3J5cHQqJyxcbiAgICAgICAgICAgICAgICAna21zOkRlc2NyaWJlKicsXG4gICAgICAgICAgICAgICAgJ2ttczpHZW5lcmF0ZURhdGFLZXkqJyxcbiAgICAgICAgICAgICAgICAna21zOlJlRW5jcnlwdConXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBTZXJ2aWNlUHJpbmNpcGFsKCdsb2dzLmFwLXNvdXRoZWFzdC0yLmFtYXpvbmF3cy5jb20nKV0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFsnKiddLFxuICAgICAgICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICAgICAgICAgIEFybkVxdWFsczoge1xuICAgICAgICAgICAgICAgICAgICAna21zOkVuY3J5cHRpb25Db250ZXh0OmF3czpsb2dzOmFybic6IGxvZ0dyb3VwTmFtZXMubWFwKG5hbWUgPT4gU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6ICdsb2dzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiBgbG9nLWdyb3VwOiR7bmFtZX1gXG4gICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpXG4gICAgfVxufVxuIl19