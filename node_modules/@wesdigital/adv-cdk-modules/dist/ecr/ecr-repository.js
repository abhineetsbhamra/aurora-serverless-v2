"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ECRRepository = void 0;
const constructs_1 = require("constructs");
const aws_ecr_1 = require("aws-cdk-lib/aws-ecr");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
class ECRRepository extends constructs_1.Construct {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e;
        super(scope, id);
        const ecrProps = props;
        const identifier = (_a = ecrProps.identifier) !== null && _a !== void 0 ? _a : '';
        const imageName = ecrProps.imageName;
        const kmsKey = ecrProps.kmsKey || 'alias/ecr';
        // TODO: extract this list to a common point if it's reused in other modules
        const accountIdList = (_b = ecrProps.accountIdList) !== null && _b !== void 0 ? _b : [
            '765018113112',
            '317585435641',
            '388942822076',
            '348279902832',
            '379399533759',
            '554417847584',
            '672557458966',
            '345954686127' // cicdtooling
        ];
        const protectedTags = (_c = ecrProps.protectedTags) !== null && _c !== void 0 ? _c : ['Prod'];
        const maxImageCount = (_d = ecrProps.maxImageCount) !== null && _d !== void 0 ? _d : 500;
        for (const key in ecrProps.tags) {
            aws_cdk_lib_1.Tags.of(this)
                .add(key, ecrProps.tags[key]);
        }
        const protectedTagRules = protectedTags.map((tagPrefix, i) => {
            return {
                description: `Protects images tagged with ${tagPrefix}`,
                rulePriority: i + 1,
                tagPrefixList: [tagPrefix],
                tagStatus: aws_ecr_1.TagStatus.TAGGED,
                maxImageCount: 999999
            };
        });
        const removeOldImageRule = {
            description: `Rotate images when reach ${maxImageCount} images stored`,
            rulePriority: protectedTagRules.length + 2,
            tagStatus: aws_ecr_1.TagStatus.ANY,
            maxImageCount: maxImageCount
        };
        const untaggedImageRule = {
            description: 'Remove untagged images',
            rulePriority: protectedTagRules.length + 1,
            maxImageCount: 1,
            tagStatus: aws_ecr_1.TagStatus.UNTAGGED
        };
        const repo = new aws_ecr_1.Repository(this, 'Repository', {
            imageScanOnPush: true,
            imageTagMutability: aws_ecr_1.TagMutability.MUTABLE,
            lifecycleRules: [...protectedTagRules, removeOldImageRule, untaggedImageRule],
            repositoryName: `${identifier}${imageName}`
        });
        const resourcePolicies = [
            {
                sid: 'pullFromRepo',
                actions: [
                    'ecr:BatchCheckLayerAvailability',
                    'ecr:BatchGetImage',
                    'ecr:DescribeImages',
                    'ecr:GetDownloadUrlForLayer'
                ],
                effect: aws_iam_1.Effect.ALLOW,
                principals: accountIdList.map(id => new aws_iam_1.AccountPrincipal(id))
            },
            {
                sid: 'LambdaECRImageCrossAccountRetrievalPolicy',
                actions: [
                    'ecr:BatchGetImage',
                    'ecr:GetDownloadUrlForLayer'
                ],
                effect: aws_iam_1.Effect.ALLOW,
                principals: [new aws_iam_1.ServicePrincipal('lambda.amazonaws.com')],
                conditions: {
                    StringLike: {
                        'aws:sourceArn': accountIdList.map(id => `"arn:aws:lambda:ap-southeast-2:${id}:function:*"`)
                    }
                }
            },
            {
                sid: 'deployToRepo',
                actions: [
                    'ecr:BatchCheckLayerAvailability',
                    'ecr:CompleteLayerUpload',
                    'ecr:InitiateLayerUpload',
                    'ecr:ListImages',
                    'ecr:PutImage',
                    'ecr:UploadLayerPart'
                ],
                effect: aws_iam_1.Effect.ALLOW,
                principals: [new aws_iam_1.AccountPrincipal(aws_cdk_lib_1.Stack.of(this).account)]
            }
        ];
        resourcePolicies.forEach(policy => repo.addToResourcePolicy(new aws_iam_1.PolicyStatement(policy)));
        const cfnRepo = (_e = repo.node) === null || _e === void 0 ? void 0 : _e.defaultChild;
        cfnRepo.encryptionConfiguration = {
            encryptionType: 'KMS',
            kmsKey
        };
        this.repository = repo;
    }
}
exports.ECRRepository = ECRRepository;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWNyLXJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvZWNyL2Vjci1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUFzQztBQUN0QyxpREFBd0c7QUFDeEcsNkNBQXlDO0FBQ3pDLGlEQUF1SDtBQVl2SCxNQUFhLGFBQWMsU0FBUSxzQkFBUztJQUd4QyxZQUFhLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXFCOztRQUM1RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRWhCLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQTtRQUV0QixNQUFNLFVBQVUsR0FBRyxNQUFBLFFBQVEsQ0FBQyxVQUFVLG1DQUFJLEVBQUUsQ0FBQTtRQUM1QyxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFBO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFBO1FBRTdDLDRFQUE0RTtRQUM1RSxNQUFNLGFBQWEsR0FBRyxNQUFBLFFBQVEsQ0FBQyxhQUFhLG1DQUFJO1lBQzVDLGNBQWM7WUFDZCxjQUFjO1lBQ2QsY0FBYztZQUNkLGNBQWM7WUFDZCxjQUFjO1lBQ2QsY0FBYztZQUNkLGNBQWM7WUFDZCxjQUFjLENBQUMsY0FBYztTQUNoQyxDQUFBO1FBQ0QsTUFBTSxhQUFhLEdBQUcsTUFBQSxRQUFRLENBQUMsYUFBYSxtQ0FBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3hELE1BQU0sYUFBYSxHQUFHLE1BQUEsUUFBUSxDQUFDLGFBQWEsbUNBQUksR0FBRyxDQUFBO1FBRW5ELEtBQUssTUFBTSxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksRUFBRTtZQUM3QixrQkFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUM7aUJBQ1IsR0FBRyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7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QTZCLENBQUE7UUFDeEQsT0FBTyxDQUFDLHVCQUF1QixHQUFHO1lBQzlCLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLE1BQU07U0FDVCxDQUFBO1FBRUQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUE7SUFDMUIsQ0FBQztDQUNKO0FBOUdELHNDQThHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnXG5pbXBvcnQgeyBDZm5SZXBvc2l0b3J5LCBMaWZlY3ljbGVSdWxlLCBSZXBvc2l0b3J5LCBUYWdNdXRhYmlsaXR5LCBUYWdTdGF0dXMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWNyJ1xuaW1wb3J0IHsgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYidcbmltcG9ydCB7IEFjY291bnRQcmluY2lwYWwsIEVmZmVjdCwgUG9saWN5U3RhdGVtZW50LCBQb2xpY3lTdGF0ZW1lbnRQcm9wcywgU2VydmljZVByaW5jaXBhbCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nXG5cbmV4cG9ydCBpbnRlcmZhY2UgRUNSTW9kdWxlUHJvcHMge1xuICAgIGFjY291bnRJZExpc3Q/OiBzdHJpbmdbXVxuICAgIGlkZW50aWZpZXI/OiBzdHJpbmdcbiAgICBpbWFnZU5hbWU6IHN0cmluZ1xuICAgIGttc0tleT86IHN0cmluZ1xuICAgIG1heEltYWdlQ291bnQ/OiBudW1iZXJcbiAgICBwcm90ZWN0ZWRUYWdzPzogc3RyaW5nW11cbiAgICB0YWdzPzoge1twOiBzdHJpbmddOiBzdHJpbmd9XG59XG5cbmV4cG9ydCBjbGFzcyBFQ1JSZXBvc2l0b3J5IGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcmVwb3NpdG9yeTogUmVwb3NpdG9yeVxuXG4gICAgY29uc3RydWN0b3IgKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBFQ1JNb2R1bGVQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpXG5cbiAgICAgICAgY29uc3QgZWNyUHJvcHMgPSBwcm9wc1xuXG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSBlY3JQcm9wcy5pZGVudGlmaWVyID8/ICcnXG4gICAgICAgIGNvbnN0IGltYWdlTmFtZSA9IGVjclByb3BzLmltYWdlTmFtZVxuICAgICAgICBjb25zdCBrbXNLZXkgPSBlY3JQcm9wcy5rbXNLZXkgfHwgJ2FsaWFzL2VjcidcblxuICAgICAgICAvLyBUT0RPOiBleHRyYWN0IHRoaXMgbGlzdCB0byBhIGNvbW1vbiBwb2ludCBpZiBpdCdzIHJldXNlZCBpbiBvdGhlciBtb2R1bGVzXG4gICAgICAgIGNvbnN0IGFjY291bnRJZExpc3QgPSBlY3JQcm9wcy5hY2NvdW50SWRMaXN0ID8/IFtcbiAgICAgICAgICAgICc3NjUwMTgxMTMxMTInLCAvLyBhZHZhbnRhZ2UtcGxhdGZvcm0tc2FuZHBpdFxuICAgICAgICAgICAgJzMxNzU4NTQzNTY0MScsIC8vIGFkdmFudGFnZS1hcHAtc2FuZHBpdFxuICAgICAgICAgICAgJzM4ODk0MjgyMjA3NicsIC8vIGFkdmFudGFnZS1kYXRhLXNhbmRwaXRcbiAgICAgICAgICAgICczNDgyNzk5MDI4MzInLCAvLyBhZHZhbnRhZ2UtYXBwLW5vbnByb2RcbiAgICAgICAgICAgICczNzkzOTk1MzM3NTknLCAvLyBhZHZhbnRhZ2UtZGF0YS1ub25wcm9kXG4gICAgICAgICAgICAnNTU0NDE3ODQ3NTg0JywgLy8gYWR2YW50YWdlLWFwcC1wcm9kXG4gICAgICAgICAgICAnNjcyNTU3NDU4OTY2JywgLy8gYWR2YW50YWdlLWRhdGEtcHJvZFxuICAgICAgICAgICAgJzM0NTk1NDY4NjEyNycgLy8gY2ljZHRvb2xpbmdcbiAgICAgICAgXVxuICAgICAgICBjb25zdCBwcm90ZWN0ZWRUYWdzID0gZWNyUHJvcHMucHJvdGVjdGVkVGFncyA/PyBbJ1Byb2QnXVxuICAgICAgICBjb25zdCBtYXhJbWFnZUNvdW50ID0gZWNyUHJvcHMubWF4SW1hZ2VDb3VudCA/PyA1MDBcblxuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBlY3JQcm9wcy50YWdzKSB7XG4gICAgICAgICAgICBUYWdzLm9mKHRoaXMpXG4gICAgICAgICAgICAgICAgLmFkZChrZXksIGVjclByb3BzLnRhZ3Nba2V5XSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb3RlY3RlZFRhZ1J1bGVzOiBMaWZlY3ljbGVSdWxlW10gPSBwcm90ZWN0ZWRUYWdzLm1hcCgodGFnUHJlZml4LCBpKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgUHJvdGVjdHMgaW1hZ2VzIHRhZ2dlZCB3aXRoICR7dGFnUHJlZml4fWAsXG4gICAgICAgICAgICAgICAgcnVsZVByaW9yaXR5OiBpICsgMSxcbiAgICAgICAgICAgICAgICB0YWdQcmVmaXhMaXN0OiBbdGFnUHJlZml4XSxcbiAgICAgICAgICAgICAgICB0YWdTdGF0dXM6IFRhZ1N0YXR1cy5UQUdHRUQsXG4gICAgICAgICAgICAgICAgbWF4SW1hZ2VDb3VudDogOTk5OTk5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIGNvbnN0IHJlbW92ZU9sZEltYWdlUnVsZTogTGlmZWN5Y2xlUnVsZSA9IHtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgUm90YXRlIGltYWdlcyB3aGVuIHJlYWNoICR7bWF4SW1hZ2VDb3VudH0gaW1hZ2VzIHN0b3JlZGAsXG4gICAgICAgICAgICBydWxlUHJpb3JpdHk6IHByb3RlY3RlZFRhZ1J1bGVzLmxlbmd0aCArIDIsXG4gICAgICAgICAgICB0YWdTdGF0dXM6IFRhZ1N0YXR1cy5BTlksXG4gICAgICAgICAgICBtYXhJbWFnZUNvdW50OiBtYXhJbWFnZUNvdW50XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdW50YWdnZWRJbWFnZVJ1bGU6IExpZmVjeWNsZVJ1bGUgPSB7XG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1JlbW92ZSB1bnRhZ2dlZCBpbWFnZXMnLFxuICAgICAgICAgICAgcnVsZVByaW9yaXR5OiBwcm90ZWN0ZWRUYWdSdWxlcy5sZW5ndGggKyAxLFxuICAgICAgICAgICAgbWF4SW1hZ2VDb3VudDogMSxcbiAgICAgICAgICAgIHRhZ1N0YXR1czogVGFnU3RhdHVzLlVOVEFHR0VEXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXBvID0gbmV3IFJlcG9zaXRvcnkodGhpcywgJ1JlcG9zaXRvcnknLCB7XG4gICAgICAgICAgICBpbWFnZVNjYW5PblB1c2g6IHRydWUsXG4gICAgICAgICAgICBpbWFnZVRhZ011dGFiaWxpdHk6IFRhZ011dGFiaWxpdHkuTVVUQUJMRSxcbiAgICAgICAgICAgIGxpZmVjeWNsZVJ1bGVzOiBbLi4ucHJvdGVjdGVkVGFnUnVsZXMsIHJlbW92ZU9sZEltYWdlUnVsZSwgdW50YWdnZWRJbWFnZVJ1bGVdLFxuICAgICAgICAgICAgcmVwb3NpdG9yeU5hbWU6IGAke2lkZW50aWZpZXJ9JHtpbWFnZU5hbWV9YFxuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IHJlc291cmNlUG9saWNpZXM6IFBvbGljeVN0YXRlbWVudFByb3BzW10gPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc2lkOiAncHVsbEZyb21SZXBvJyxcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICdlY3I6QmF0Y2hDaGVja0xheWVyQXZhaWxhYmlsaXR5JyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpCYXRjaEdldEltYWdlJyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpEZXNjcmliZUltYWdlcycsXG4gICAgICAgICAgICAgICAgICAgICdlY3I6R2V0RG93bmxvYWRVcmxGb3JMYXllcidcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHByaW5jaXBhbHM6IGFjY291bnRJZExpc3QubWFwKGlkID0+IG5ldyBBY2NvdW50UHJpbmNpcGFsKGlkKSlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc2lkOiAnTGFtYmRhRUNSSW1hZ2VDcm9zc0FjY291bnRSZXRyaWV2YWxQb2xpY3knLFxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpCYXRjaEdldEltYWdlJyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpHZXREb3dubG9hZFVybEZvckxheWVyJ1xuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBTZXJ2aWNlUHJpbmNpcGFsKCdsYW1iZGEuYW1hem9uYXdzLmNvbScpXSxcbiAgICAgICAgICAgICAgICBjb25kaXRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIFN0cmluZ0xpa2U6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdhd3M6c291cmNlQXJuJzogYWNjb3VudElkTGlzdC5tYXAoaWQgPT4gYFwiYXJuOmF3czpsYW1iZGE6YXAtc291dGhlYXN0LTI6JHtpZH06ZnVuY3Rpb246KlwiYClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc2lkOiAnZGVwbG95VG9SZXBvJyxcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICdlY3I6QmF0Y2hDaGVja0xheWVyQXZhaWxhYmlsaXR5JyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpDb21wbGV0ZUxheWVyVXBsb2FkJyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpJbml0aWF0ZUxheWVyVXBsb2FkJyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpMaXN0SW1hZ2VzJyxcbiAgICAgICAgICAgICAgICAgICAgJ2VjcjpQdXRJbWFnZScsXG4gICAgICAgICAgICAgICAgICAgICdlY3I6VXBsb2FkTGF5ZXJQYXJ0J1xuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBBY2NvdW50UHJpbmNpcGFsKFN0YWNrLm9mKHRoaXMpLmFjY291bnQpXVxuICAgICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICAgIHJlc291cmNlUG9saWNpZXMuZm9yRWFjaChwb2xpY3kgPT4gcmVwby5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQocG9saWN5KSkpXG5cbiAgICAgICAgY29uc3QgY2ZuUmVwbyA9IHJlcG8ubm9kZT8uZGVmYXVsdENoaWxkIGFzIENmblJlcG9zaXRvcnlcbiAgICAgICAgY2ZuUmVwby5lbmNyeXB0aW9uQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgICAgIGVuY3J5cHRpb25UeXBlOiAnS01TJyxcbiAgICAgICAgICAgIGttc0tleVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXBvc2l0b3J5ID0gcmVwb1xuICAgIH1cbn1cbiJdfQ==